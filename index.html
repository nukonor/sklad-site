<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>–°–∫–ª–∞–¥ v520 "–ö–∞–ª–µ–Ω–¥–∞—Ä—å"</title>
<script>
    window.onerror = function(msg, url, line) {
        alert("–û–®–ò–ë–ö–ê:\n" + msg + "\n–°—Ç—Ä–æ–∫–∞: " + line + "\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç!");
        return false;
    };
</script>
<link rel="icon" type="image/png" sizes="192x192" href="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png">
<style>
/* GLOBAL & RESET */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
:root { --bg: #f1f5f9; --p: #4f46e5; --d: #ef4444; --s: #10b981; --t: #1e293b; --w: #fff; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 5px; padding-bottom: 80px; color: var(--t); overflow-x: hidden; width: 100vw; }

/* LOCK SCREEN */
#lockScreen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: opacity 0.3s; }
.lock-hidden { opacity: 0; pointer-events: none; }
.lock-logo { width: 100px; margin-bottom: 20px; }
.lock-title { font-size: 14px; font-weight: 900; color: #94a3b8; letter-spacing: 2px; margin-bottom: 30px; text-transform: uppercase; }
.lock-inp { width: 100%; max-width: 250px; padding: 15px; font-size: 18px; text-align: center; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 10px; }

/* DASHBOARD */
.dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-width: 100%; margin: 0 auto; }
.dash-item { background: var(--w); border-radius: 16px; padding: 15px 5px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); color: var(--p); font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; border: 1px solid #e2e8f0; transition: 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; }
.dash-item:active { transform: scale(0.97); background: #eef2ff; }
.dash-item span { font-size: 24px; margin-bottom: 8px; display: block; }

/* CARD */
.card { background: var(--w); border-radius: 16px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; position: relative; width: 100%; }
.btn-main { background: var(--p); color: #fff; border: none; width: 100%; padding: 14px; font-size: 13px; font-weight: 700; border-radius: 12px; margin: 5px 0; text-transform: uppercase; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); transition: 0.2s; cursor: pointer; }
.btn-main:active { transform: translateY(1px); box-shadow: none; }
.btn-main:disabled { background: #94a3b8; cursor: not-allowed; }

/* NAV */
.bottom-nav { display: none; position: fixed; bottom: 10px; left: 10px; right: 10px; background: #fff; border-radius: 20px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); padding: 5px; z-index: 900; grid-template-columns: 1fr 1fr; gap: 5px; border: 1px solid #e2e8f0; }
.bottom-nav button { background: transparent; border: none; padding: 12px; border-radius: 14px; color: #94a3b8; font-weight: 800; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
.bottom-nav button.nav-btn-active { background: #eef2ff; color: var(--p); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
body.nav-active .bottom-nav { display: grid; }

input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; background: #fff; font-weight: 600; color: #0f172a; }
input:focus, select:focus { border-color: var(--p); background: #f8fafc; }

/* ITEMS GRID */
.item-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
.item-card { background: #fff; border-radius: 12px; padding: 10px 2px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; position: relative; }
.item-title { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 4px; height: 22px; overflow: hidden; line-height: 1.1; word-break: break-word; }
.item-qty { font-size: 14px; font-weight: 900; color: #0f172a; margin-bottom: 4px; }
.alarm-blink { background: #fef2f2 !important; border: 1px solid var(--d) !important; animation: blink 1s infinite alternate; }

/* MODAL */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.modal-box { background: #fff; width: 96%; max-width: 400px; border-radius: 20px; max-height: 94vh; display: flex; flex-direction: column; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.2); }
.modal-body { overflow-y: auto; padding: 15px; }

/* UTILS */
.report-line { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px dashed #e2e8f0; }
.history-btn { border: none; background: #e0e7ff; color: var(--p); border-radius: 8px; padding: 8px; font-weight: 700; font-size: 12px; width: 45%; }
.corr-btn { display: none; border: none; background: #fef3c7; color: #d97706; border-radius: 8px; padding: 8px; font-weight: 700; font-size: 12px; width: 45%; margin-top: 4px; }
.show-corr .corr-btn { display: inline-block; }
.hist-pos { color: var(--p) !important; font-weight: 700; } .hist-neg { color: var(--d) !important; font-weight: 700; }

/* ARCHIVE TILES */
.arch-y-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; width: 100%; }
.arch-tile-y { background: #3b82f6; color: #fff; padding: 25px 5px; border-radius: 16px; text-align: center; font-weight: 900; font-size: 20px; cursor: pointer; box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.4); }
.arch-m-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; width: 100%; }
.arch-tile-m { background: #fff; border: 1px solid #cbd5e1; border-radius: 12px; padding: 15px 2px; text-align: center; font-size: 10px; font-weight: 700; color: #334155; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-transform:uppercase; }
.arch-content { display: none; margin-bottom: 15px; width: 100%; }
.arch-inv { background: #fff; border-left: 4px solid var(--p); border-radius: 12px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; font-size: 13px; cursor: pointer; border: 1px solid #f1f5f9; width: 100%; }
.arch-tile-c { background: #fff; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; font-weight:700; font-size:13px; margin-bottom:5px; cursor:pointer }
.arch-badge { background:#eef2ff; color:var(--p); padding:2px 6px; border-radius:6px; font-size:10px; }

/* JOURNAL CARDS */
.j-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 8px; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; position: relative; }
.j-head { font-weight: 900; font-size: 14px; text-transform: uppercase; color: var(--p); margin-bottom: 4px; }
.j-sub { font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 12px; border-bottom:1px solid #f1f5f9; padding-bottom:6px; }
.j-title { font-size: 16px; font-weight: 800; color: #1e293b; margin-bottom: 10px; }
.j-body { font-size: 13px; color: #334155; }
.j-row { display: flex; justify-content: space-between; padding: 4px 0; align-items:end; margin-bottom:2px; }
.j-dots { flex-grow: 1; border-bottom: 1px dotted #94a3b8; margin: 0 6px; position: relative; top: -5px; color:#334155; font-weight:600; font-size:13px; }
.j-val { font-weight:800; color:#0f172a; white-space:nowrap; }

/* BASKET */
.bulk-q{border:2px solid #e2e8f0!important;text-align:center;color:var(--p)}
.bulk-q:focus{border-color:var(--p)!important;background:#eef2ff}

/* OTHER UTILS */
.logo-box { text-align: center; margin-bottom: 20px; margin-top: 5px; }
.logo-img { max-width: 220px; height: auto; object-fit: contain; }
.l-t { font-size:9px; font-weight:800; color:#64748b; margin-bottom:2px; display:block; text-transform:uppercase; }
.smart-wrap { width:100%; height:30px; position:relative; }
.smart-sel, .smart-inp, .u-inp { width:100%; height:100%; border:1px solid #cbd5e1; border-radius:6px; font-size:13px; background:#fff; padding:0 5px; margin:0; box-sizing:border-box; font-weight:600; color:#1e293b; }
.smart-inp { display:none; border:1px solid var(--p); }
.u-inp { text-align:center; }
.del-row-btn { width:100%; height:30px; background:#fee2e2; border:1px solid #fca5a5; color:red; border-radius:6px; font-weight:900; display:flex; align-items:center; justify-content:center; }
.dyn-row { display: grid; grid-template-columns: 32% 16% 16% 16% 8%; gap:4px; align-items: center; margin-bottom:5px; }
.z-head { font-size:10px; color:#047857; font-weight:900; text-align:center; margin:15px 0 5px; letter-spacing:1px; background:#ecfdf5; padding:4px; border-radius:4px; text-transform: uppercase; }
.z-col-h { display:grid; grid-template-columns: 32% 16% 16% 16% 8%; gap:4px; text-align:center; font-size:9px; color:#64748b; font-weight:700; margin-bottom:4px; }
.del-rep-btn { position: absolute; top: 5px; right: 5px; background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; width: 28px; height: 28px; border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 99; opacity: 0.3; transition: 0.2s; }
.del-rep-btn:active { opacity: 1; transform: scale(1.1); }
.day-rep-box { background: #f8fafc; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; font-family: monospace; font-size: 12px; color: #333; white-space: pre-wrap; margin-bottom: 10px; }
.dr-h { font-weight: 900; border-bottom: 1px dashed #94a3b8; margin: 10px 0 5px; color: #000; text-transform: uppercase; }

@media print {
    body { background: white; padding: 0; }
    #lockScreen, #act, .bottom-nav, .dash-item, .btn-main, .logo-box, #corrCtls, .history-btn, .corr-btn, #navM, #navB { display: none !important; }
    #cnt { display: block !important; position: static; width: 100%; }
    .z-head { background: none !important; border: none !important; color: #000 !important; font-size: 14px !important; text-align: left !important; padding-left: 0 !important; margin-top: 20px !important; border-bottom: 2px solid #000 !important; }
    .item-card { box-shadow: none !important; border: none !important; border-bottom: 1px dotted #ccc !important; padding: 5px 0 !important; margin: 0 !important; }
    .item-grid { display: block !important; }
}

@keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }
</style>
</head>
<body>
<div id="lockScreen">
    <img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="lock-logo">
    <div class="lock-title">–°–ò–°–¢–ï–ú–ê –£–ß–ï–¢–ê</div>
    <input type="password" id="appPass" class="lock-inp" placeholder="–ü–∞—Ä–æ–ª—å">
    <button class="btn-main" style="max-width:250px" onclick="tryLogin()">–û–¢–ö–†–´–¢–¨</button>
</div>

<div id="act"></div>
<div id="cnt"></div>
<div class="bottom-nav">
<button id="navM" onclick="renderHome()">–ú–ï–ù–Æ</button>
<button id="navB" onclick="goBack()">–ù–ê–ó–ê–î</button>
</div>
<div id="mdl" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;padding:15px;border-bottom:1px solid #eee"><h4 id="mT" style="margin:0;font-size:16px"></h4><button onclick="closeModal()" style="border:none;background:none;font-size:24px;color:#999">‚úï</button></div><div id="mB" class="modal-body"></div></div></div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –¶–ï–•–û–í ===
const WS_CFG = {
    'VIBRO': { title: '–í–∏–±—Ä–æ—Å—Ç–æ–ª', db: 'Vibro_Report', prefix: 'v', note: '–í–∏–±—Ä–æ' },
    'KRUP':  { title: '–ö—Ä—É–ø–æ—Ä—É—à–∫–∞', db: 'Krup_Report',  prefix: 'k', note: '–ö—Ä—É–ø–æ—Ä—É—à–∫–∞' },
    'ZSHM':  { title: '–ó–®–ú –°–º–µ–Ω–∞',  db: 'ZSHM_Report',  prefix: 'z', note: '–ó–®–ú' }
};

function tryLogin() {
    const p = document.getElementById('appPass').value;
    if(p === '1111') {
        document.getElementById('lockScreen').classList.add('lock-hidden');
        document.body.classList.add('nav-active');
        isLogged = true;
        renderHome();
    } else {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    }
}

const cfg={apiKey:"AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q",databaseURL:"https://myproductionapp-bd872-default-rtdb.firebaseio.com",projectId:"myproductionapp-bd872"};
if(!firebase.apps.length)firebase.initializeApp(cfg);
const db=firebase.database().ref('production'),auth=firebase.auth();

let cur='Home',data={},aId=null,archSub='',corrMode=false,isLogged=false;
let corrCtx = {}; 

window.delRec = async function(cat, id) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
    await db.child(cat).child(id).remove();
    closeModal();
};

window.delInvoiceFull = async function(cat, id) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é –∏ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º?')) return;
    const updates = {};
    updates[`/${cat}/${id}`] = null; 
    const stockCats = ['Stock_DV', 'Stock_Semi', 'Stock_Feed', 'Stock_Raw', 'WeightStock', '–ì–æ—Ç–æ–≤–∞—è', '–ü–∞–∫–µ—Ç—ã', '–ü–ª–µ–Ω–∫–∞', '–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º', '–ú–µ—à–∫–∏', '–ù–∏—Ç–∫–∏', '–≠—Ç–∏–∫–µ—Ç–∫–∞'];
    stockCats.forEach(sc => {
        if(data[sc]) {
            Object.entries(data[sc]).forEach(([key, val]) => {
                if(val.fLink === id) updates[`/${sc}/${key}`] = null; 
            });
        }
    });
    try { await db.update(updates); } catch(e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: " + e); }
};

window.delWorkshopReportFull = async function(dbName, id) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –∏ –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã/–ø—Ä–æ–¥—É–∫—Ü–∏—é –Ω–∞ —Å–∫–ª–∞–¥?')) return;
    const updates = {};
    updates[`/${dbName}/${id}`] = null; 
    const stockCats = ['Stock_DV', 'Stock_Semi', 'Stock_Feed', 'Stock_Raw', 'WeightStock', '–ì–æ—Ç–æ–≤–∞—è', '–ü–∞–∫–µ—Ç—ã', '–ü–ª–µ–Ω–∫–∞', '–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º', '–ú–µ—à–∫–∏', '–ù–∏—Ç–∫–∏', '–≠—Ç–∏–∫–µ—Ç–∫–∞'];
    stockCats.forEach(sc => {
        if(data[sc]) {
            Object.entries(data[sc]).forEach(([key, val]) => {
                if(val.fLink === id) updates[`/${sc}/${key}`] = null; 
            });
        }
    });
    try { await db.update(updates); alert("–û—Ç—á–µ—Ç —É–¥–∞–ª–µ–Ω, –æ—Å—Ç–∞—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã."); } catch(e) { alert("–û—à–∏–±–∫–∞: " + e); }
};

window.delFasFull = async function(id) {
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç —Ñ–∞—Å–æ–≤–∫–∏?')) return;
    const updates = {};
    updates['/–§–∞—Å–æ–≤–∫–∞/'+id] = null;
    const stockCats = ['WeightStock','Stock_DV','–ì–æ—Ç–æ–≤–∞—è','–ü–∞–∫–µ—Ç—ã','–ü–ª–µ–Ω–∫–∞','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'];
    stockCats.forEach(cat => {
        if(data[cat]) {
            Object.entries(data[cat]).forEach(([key, val]) => {
                if(val.fLink === id) updates[`/${cat}/${key}`] = null; 
            });
        }
    });
    try { await db.update(updates); alert("–§–∞—Å–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞, –æ—Å—Ç–∞—Ç–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã."); } catch(e) { alert("–û—à–∏–±–∫–∞: " + e); }
};

window.delFas = (id) => window.delRec('–§–∞—Å–æ–≤–∫–∞', id);
window.delKrup = (id) => window.delRec('Krup_Report', id);
window.delVibro = (id) => window.delRec('Vibro_Report', id);
window.delZSHM = (id) => window.delRec('ZSHM_Report', id);
window.delArchRec = (cat, id) => window.delRec(cat, id);

const bP=["–ê—Ä–Ω–∞—É—Ç–∫–∞","–ê—Ä—Ç–µ–∫","–ë–∞—Å–º–∞—Ç–∏ –≥","–ë–∞—Å–º–∞—Ç–∏ –∫","–ë—É–ª–≥—É—Ä","–ì–æ—Ä–æ—Ö","–ì—Ä–µ—á–∫–∞","–ö—É–∫—É—Ä—É–∑–∞","–ö—É–∫.–º—É–∫–∞","–ö—É—Å –∫—É—Å","–ö—É—Ç—è","–ú–∞–Ω–∫–∞","–ù—É—Ç","–ü–µ—Ä–ª–æ–≤–∫–∞","–ü—à–µ–Ω–∏—á–∫–∞","–ü—à–æ–Ω–æ","–†–∏—Å –¥–ª","–†–∏—Å –∫—Ä","–†–∏—Å –ø—Ä","–•–ª–æ–ø—å—è","–ß–µ—á–µ–≤–∏—Ü–∞","–Ø—á–∫–∞"],szs=["300√ó400","370√ó500","400√ó500","420√ó550"],mths=["–Ø–ù–í","–§–ï–í","–ú–ê–†–¢","–ê–ü–†","–ú–ê–ô","–ò–Æ–ù–¨","–ò–Æ–õ–¨","–ê–í–ì","–°–ï–ù–¢","–û–ö–¢","–ù–û–Ø–ë","–î–ï–ö"];
const fd=i=>{if(!i)return'';const parts=i.split('T')[0].split('-');return `${parts[2]}.${parts[1]}.${parts[0]} ${parts[1]}:${parts[2]}`};const fd2=i=>{if(!i)return'';const parts=i.split('T')[0].split('-');return `${parts[2]}.${parts[1]}.${parts[0]}`};
function closeModal(){document.getElementById('mdl').style.display='none';aId=null;}
function toggleF(id){const e=document.getElementById(id);e.style.display=e.style.display==='block'?'none':'block'}
function toggleC(id, btn){ const e=document.getElementById(id); if(e.style.display==='block'){ e.style.display='none'; btn.style.background='#fff'; btn.style.borderColor='#e2e8f0'; } else { e.style.display='block'; btn.style.background='#eef2ff'; btn.style.borderColor='var(--p)'; } }

const gP=(cat)=>{ let init=[]; if(cat==='WeightStock'||cat==='–ì–æ—Ç–æ–≤–∞—è') init=bP; const s=new Set(init); const dbK=(cat==='WeightStock')?'WeightStock':(cat==='Stock_DV'?'Stock_DV':(cat==='Stock_Feed'?'Stock_Feed':(cat==='Stock_Raw'?'Stock_Raw':(cat==='Stock_Semi'?'Stock_Semi':'–ì–æ—Ç–æ–≤–∞—è')))); if(data[dbK])Object.values(data[dbK]).forEach(v=>s.add(v.name)); return Array.from(s).filter(x=>x).sort(); };
const gCl=()=>{const s=new Set();if(data.ArchInvoices)Object.values(data.ArchInvoices).forEach(v=>s.add(v.client));return Array.from(s).filter(x=>x).sort();};
const gPack=(cat)=>{const s=new Set();if(cat==='–ü–∞–∫–µ—Ç—ã')szs.forEach(x=>s.add(x));if(cat==='–°–∫–æ—Ç—á')s.add('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º');if(cat==='–ü–ª–µ–Ω–∫–∞')bP.forEach(x=>s.add(x));const dbK=cat==='–°–∫–æ—Ç—á'?'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':cat;if(data[dbK])Object.values(data[dbK]).forEach(v=>{if(v.name)s.add(v.name)});return Array.from(s).filter(x=>x).sort();};

// 1. –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ —É–ø–∞–∫–æ–≤–∫–∏
const gPackS = () => {
    const s = new Set();
    if(data.ArchPackIn) Object.values(data.ArchPackIn).forEach(v => { if(v.supplier) s.add(v.supplier); });
    return Array.from(s).filter(x=>x).sort();
};

// 2. –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –ø–æ–∫—É–ø–Ω–æ–π (–°–¢–†–û–ì–ò–ô –§–ò–õ–¨–¢–†: –¢–û–õ–¨–ö–û –¢–ï, –£ –ö–û–ì–û –ï–°–¢–¨ –ú–ï–¢–ö–ê GOODS)
const gBuyS = () => {
    const s = new Set();
    if(data.ArchIncoming) Object.values(data.ArchIncoming).forEach(v => { 
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫—Ç–æ —è–≤–Ω–æ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –¢–û–í–ê–†
        if(v.supplier && v.type === 'GOODS') s.add(v.supplier); 
    });
    return Array.from(s).filter(x=>x).sort();
};

// 3. –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ —Å—ã—Ä—å—è (–¢–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –ï–°–¢–¨ –ù–ê –û–°–¢–ê–¢–ö–ê–•)
const gRawActive = () => {
    const s = new Set();
    // –°–º–æ—Ç—Ä–∏–º —Ç–µ–∫—É—â–∏–π —Å–∫–ª–∞–¥ —Å—ã—Ä—å—è
    if(data.Stock_Raw) {
        const sums = {};
        Object.values(data.Stock_Raw).forEach(v => {
            if(v.name) sums[v.name] = (sums[v.name] || 0) + v.amount;
        });
        
        // –†–∞–∑–±–∏—Ä–∞–µ–º –∏–º–µ–Ω–∞ –≤–∏–¥–∞ "–ì—Ä–µ—á–∫–∞ [–§–µ—Ä–º–µ—Ä]"
        Object.keys(sums).forEach(fullName => {
            if(sums[fullName] > 0.01) { // –ï—Å–ª–∏ –æ—Å—Ç–∞—Ç–æ–∫ –±–æ–ª—å—à–µ 0
                const match = fullName.match(/\[(.*?)\]/); // –ò—â–µ–º —Ç–µ–∫—Å—Ç –≤ —Å–∫–æ–±–∫–∞—Ö
                if(match && match[1]) {
                    s.add(match[1]); // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
                }
            }
        });
    }
    return Array.from(s).filter(x=>x).sort();
};

function renderHome(){
    if(!isLogged) return;
    cur='Home';
    document.body.classList.remove('nav-active');
    document.getElementById('act').innerHTML='';
    const logo=`<div class="logo-box"><img src="https://i.ibb.co/Gv0xDqnt/file-00000000ff1471f4b6d9f9d2c686ef67.png" class="logo-img"></div>`;
    document.getElementById('cnt').innerHTML=`${logo}<div class="dash-grid">
        <div class="dash-item" onclick="setCat('StockRoot')"><span>üì¶</span>–°–∫–ª–∞–¥</div>
        <div class="dash-item" onclick="setCat('ProdSub')"><span>‚öôÔ∏è</span>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</div>
        <div class="dash-item" onclick="setCat('Consolidated')"><span>üìä</span>–°–í–û–î–ù–´–ô –û–¢–ß–ï–¢</div>
    </div>`;
    updNav();
}
function goBack(){const m={'StockList':'StockRoot','WeightStock':'StockRoot','Stock_DV':'StockRoot','Stock_Feed':'StockRoot','Stock_Semi':'StockRoot','Stock_Raw':'StockRoot','Invoices':'StockRoot','PackSub':'StockRoot','ArchSubIn':'Invoices','ArchSubOut':'Invoices','InvoicesDate':'ArchSub','InvoicesClient':'ArchSub','–§–∞—Å–æ–≤–∫–∞':'ProdSub','Kruporushka':'ProdSub','ZSHM':'ProdSub','Vibro':'ProdSub','–ü–ª–µ–Ω–∫–∞':'PackSub','–ü–∞–∫–µ—Ç—ã':'PackSub','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'PackSub','–ú–µ—à–∫–∏':'PackSub','–ù–∏—Ç–∫–∏':'PackSub','–≠—Ç–∏–∫–µ—Ç–∫–∞':'PackSub','ArchPackIn':'PackSub','Consolidated':'Home'};let next=m[cur]||'Home';if(cur==='InvoicesDate'||cur==='InvoicesClient')next=archSub==='In'?'ArchSubIn':'ArchSubOut';setCat(next);}
function setCat(c){cur=c;document.body.classList.add('nav-active');const a=document.getElementById('act'),ct=document.getElementById('cnt');a.innerHTML='';if(c==='Home'){renderHome();return}
if(c==='StockRoot'){
    a.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:10px">
        <button class="btn-main" style="background:var(--s);padding:10px 2px;font-size:10px" onclick="openModal('inc')">–ü—Ä–∏—Ö–æ–¥</button>
        <button class="btn-main" style="background:var(--d);padding:10px 2px;font-size:10px" onclick="openModal('ship')">–û—Ç–≥—Ä—É–∑–∫–∞</button>
    </div>`;
    ct.innerHTML=`<div class="dash-grid">
        <div class="dash-item" onclick="setCat('StockList')">–§–ê–°–û–í–ê–ù–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø</div>
        <div class="dash-item" onclick="setCat('WeightStock')">–ü–û–ö–£–ü–ù–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø –í–ï–°–û–í–ê–Ø</div>
        <div class="dash-item" onclick="setCat('Stock_DV')">–°–ö–õ–ê–î –ì–û–¢–û–í–û–ô –í–ï–°–û–í–û–ô –ü–†–û–î–£–ö–¶–ò–ò –° –ü–†–û–ò–ó–í–û–î–°–¢–í–ê</div>
        <div class="dash-item" onclick="setCat('Stock_Feed')">–û–¢–•–û–î–´ –° –ü–†–û–ò–ó–í–û–î–°–¢–í–ê</div>
        <div class="dash-item" onclick="setCat('Stock_Raw')">–°–´–†–¨–Å(–ó–ï–†–ù–û)–°–´–†–¨–ï–í–´–ï –°–ö–õ–ê–î–´</div>
        <div class="dash-item" onclick="setCat('Stock_Semi')">–ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢</div>
        <div class="dash-item" onclick="setCat('PackSub')">–£–ü–ê–ö. –ú–ê–¢.</div>
        <div class="dash-item" onclick="setCat('Invoices')">–ê–†–•–ò–í –ù–ê–ö–õ–ê–î–ù–´–•</div>
        <div id="corrTile" class="dash-item" onclick="toggleCorr()" style="grid-column:1/-1">–ö–û–†–†–ï–ö–¶–ò–Ø</div>
    </div>
    <div id="corrCtls" style="margin-top:15px;display:flex;gap:5px;justify-content:center"></div>`;
}else if(c==='PackSub'){
    a.innerHTML=`<button class="btn-main" style="background:var(--s)" onclick="openModal('addMatPack')">–ü—Ä–∏—Ö–æ–¥ —É–ø–∞–∫–æ–≤–∫–∏</button>`;
    ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–ü–ª–µ–Ω–∫–∞')">–ü–õ–ï–ù–ö–ê</div><div class="dash-item" onclick="setCat('–ü–∞–∫–µ—Ç—ã')">–ü–ê–ö–ï–¢–´</div><div class="dash-item" onclick="setCat('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')">–°–ö–û–¢–ß</div><div class="dash-item" onclick="setCat('–ú–µ—à–∫–∏')">–ú–ï–®–ö–ò</div><div class="dash-item" onclick="setCat('–ù–∏—Ç–∫–∏')">–ù–ò–¢–ö–ò</div><div class="dash-item" onclick="setCat('–≠—Ç–∏–∫–µ—Ç–∫–∞')">–≠–¢–ò–ö–ï–¢–ö–ê</div><div class="dash-item" onclick="setCat('ArchPackIn')" style="grid-column:1/-1;">–ê–†–•–ò–í –£–ü–ê–ö–û–í–ö–ò</div></div>`;
}else if(c==='ProdSub')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–§–∞—Å–æ–≤–∫–∞')">–¶–µ—Ö —Ñ–∞—Å–æ–≤–∫–∏</div><div class="dash-item" onclick="setCat('Kruporushka')">–ö—Ä—É–ø–æ—Ä—É—à–∫–∞</div><div class="dash-item" onclick="setCat('ZSHM')">–ó–®–ú</div><div class="dash-item" onclick="setCat('Vibro')">–í–∏–±—Ä–æ—Å—Ç–æ–ª</div></div><button class="btn-main" style="background:var(--s);margin-top:10px" onclick="openModal('addRaw')">–ü–†–ò–•–û–î –°–´–†–¨–Ø</button>`;else if(c==='–§–∞—Å–æ–≤–∫–∞')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('fas')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;
else if(c==='Kruporushka')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('KRUP')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;
else if(c==='Vibro')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('VIBRO')">–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨</button>`;
else if(c==='ZSHM')a.innerHTML=`<button class="btn-main" style="background:var(--p)" onclick="openModal('ZSHM')">–ù–û–í–ê–Ø –°–ú–ï–ù–ê</button>`;
else if(c==='Invoices')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('ArchSubIn')">–ü—Ä–∏—Ö–æ–¥—ã</div><div class="dash-item" onclick="setCat('ArchSubOut')">–û—Ç–≥—Ä—É–∑–∫–∏</div></div>`;else if(c==='ArchSubIn'||c==='ArchSubOut'){archSub=(c==='ArchSubIn'?'In':'Out');ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('InvoicesDate')">–ü–æ –¥–∞—Ç–∞–º</div><div class="dash-item" onclick="setCat('InvoicesClient')">–ü–æ –∏–º–µ–Ω–∞–º</div></div>`;}
else if(c==='Consolidated'){ ct.innerHTML='<div style="text-align:center;padding:20px;color:#666">–ó–∞–≥—Ä—É–∑–∫–∞...</div>'; loadData(); }
loadData();updCorrBtn();updNav();}
function toggleCorr(){corrMode=!corrMode;updCorrBtn();loadData();}
function updCorrBtn(){
    const t=document.getElementById('corrTile');
    if(t){
        t.innerText=corrMode?'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–ö–õ':'–ö–û–†–†–ï–ö–¶–ò–Ø';
        t.style.background=corrMode?'#fef3c7':'#fff';
        t.style.color=corrMode?'#d97706':'var(--p)';
    }
    const c=document.getElementById('corrCtls');
    if(c) c.innerHTML='';
}
function updNav(){document.getElementById('navM').className=`${cur==='Home'?'nav-btn-active':''}`;document.getElementById('navB').className=`${cur!=='Home'?'nav-btn-active':''}`;}
function loadData(){db.on('value',s=>{data=s.val()||{};const c=document.getElementById('cnt');if(!c||['Home','StockRoot','Invoices','ArchSubIn','ArchSubOut','ProdSub','PackSub'].includes(cur))return;if(cur==='InvoicesDate')rInvD(c);else if(cur==='InvoicesClient')rInvC(c);else if(cur==='ArchPackIn')rArchPack(c);else if(cur==='–§–∞—Å–æ–≤–∫–∞')rFas(c);else if(cur==='Kruporushka')rKrup(c);else if(cur==='Vibro')rVibro(c);else if(cur==='ZSHM')rZSHM(c);else if(cur==='StockList')rWH(c);else if(cur==='WeightStock')rWgh(c);else if(cur==='Stock_Raw')rRaw(c);else if(cur==='Consolidated')rConsolidated(c);else rGen(c);});}
function toggleInput(id){const sel=document.getElementById('s_'+id),inp=document.getElementById('i_'+id);if(sel.value==='NEW'){sel.style.display='none';inp.style.display='block';inp.focus();}else{inp.style.display='none';}}

function drawShipItem(str) {
    let p=str.split('|');
    if(p.length<2 && str.includes(':')){p=str.split(':')} 
    let n=p[0], a=p[1], u=p[2];
    if(!u) { u = bP.includes(n) ? '—à—Ç' : '–∫–≥'; }
    return `<div class="j-row"><span class="j-dots">${n}</span><span class="j-val">${a}${u}</span></div>`;
}

function rConsolidated(c) {
    const sumCat = (cats) => {
        let res = {};
        cats.forEach(catName => {
            if(data[catName]) Object.values(data[catName]).forEach(v => {
                res[v.name] = (res[v.name] || 0) + v.amount;
            });
        });
        return res;
    };
    const drawSection = (title, dataObj, unit, color) => {
        let items = Object.keys(dataObj).filter(k => Math.abs(dataObj[k]) > 0.1).sort();
        if(items.length === 0) return '';
        let h = `<div class="z-head" style="background:${color};color:#333;border:1px solid #ddd">${title}</div><div class="item-grid" style="grid-template-columns:1fr 1fr;">`;
        items.forEach(k => {
            let val = dataObj[k];
            h += `<div class="item-card" style="text-align:left;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:11px;font-weight:700;color:#475569">${k}</span>
                <span style="font-size:14px;font-weight:900;color:#0f172a">${Math.round(val)}<small style="font-size:9px;color:#94a3b8;margin-left:2px">${unit}</small></span>
            </div>`;
        });
        return h + `</div>`;
    };
    let h = '<div id="print-area" style="padding-bottom:20px">';
    h += `<div style="margin-bottom:15px;display:grid;grid-template-columns:1fr 1fr;gap:10px"><button class="btn-main" onclick="openModal('dayRep')" style="background:#4f46e5;border:1px solid #4338ca">üìÖ –î–ù–ï–í–ù–û–ô –û–¢–ß–ï–¢</button><button class="btn-main" onclick="shareRep()" style="background:#fff;color:#4f46e5;border:1px solid #4f46e5">üì§ –û–¢–ü–†–ê–í–ò–¢–¨ –°–í–û–î–ö–£</button></div>`;
    let fas = sumCat(['–ì–æ—Ç–æ–≤–∞—è']); h += drawSection('üì¶ –§–ê–°–û–í–ö–ê', fas, '—à—Ç', '#dbeafe');
    let dv = sumCat(['Stock_DV']); h += drawSection('üè≠ –°–ö–õ–ê–î –î–í', dv, '–∫–≥', '#bfdbfe');
    let wgh = sumCat(['WeightStock']); h += drawSection('‚öñÔ∏è –ü–û–ö–£–ü–ù–ê–Ø', wgh, '–∫–≥', '#dcfce7');
    let raw = sumCat(['Stock_Raw']); h += drawSection('üöú –°–´–†–¨–Å', raw, '–∫–≥', '#bbf7d0');
    let semi = sumCat(['Stock_Semi']); h += drawSection('‚öôÔ∏è –ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢', semi, '–∫–≥', '#ffedd5');
    let feed = sumCat(['Stock_Feed']); h += drawSection('üçÇ –ö–û–†–ú–ê', feed, '–∫–≥', '#fef3c7');
    let packs = sumCat(['–ü–∞–∫–µ—Ç—ã']); h += drawSection('ü•° –ü–ê–ö–ï–¢–´', packs, '—à—Ç', '#f1f5f9');
    let film = sumCat(['–ü–ª–µ–Ω–∫–∞']); h += drawSection('üéûÔ∏è –ü–õ–ï–ù–ö–ê', film, '–∫–≥', '#f1f5f9');
    let tape = sumCat(['–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º']); h += drawSection('üß¥ –°–ö–û–¢–ß', tape, '—à—Ç', '#f1f5f9');
    let sacks = sumCat(['–ú–µ—à–∫–∏']); h += drawSection('üí∞ –ú–ï–®–ö–ò', sacks, '—à—Ç', '#f1f5f9');
    let thread = sumCat(['–ù–∏—Ç–∫–∏']); h += drawSection('üßµ –ù–ò–¢–ö–ò', thread, '—à—Ç', '#f1f5f9');
    let label = sumCat(['–≠—Ç–∏–∫–µ—Ç–∫–∞']); h += drawSection('üè∑Ô∏è –≠–¢–ò–ö–ï–¢–ö–ê', label, '—à—Ç', '#f1f5f9');
    h += '</div>';
    h += `<div style="margin-top:15px;border-top:1px dashed #ccc;padding-top:15px"><button class="btn-main" onclick="openModal('fixBal')" style="background:#f59e0b;color:#fff;border:1px solid #d97706">üîí –ó–ê–§–ò–ö–°–ò–†–û–í–ê–¢–¨ –ù–ê–ß–ê–õ–û –ú–ï–°–Ø–¶–ê</button><div style="font-size:10px;color:#666;text-align:center;margin-top:5px">–°–æ–∑–¥–∞—Ç—å –º–µ—Ç–∫—É "–û—Å—Ç–∞—Ç–æ–∫" –≤ –∏—Å—Ç–æ—Ä–∏–∏</div></div>`;
    c.innerHTML = h || '<div style="text-align:center;padding:20px;color:#999">–°–∫–ª–∞–¥—ã –ø—É—Å—Ç—ã</div>';
}

function shareRep() {
    let txt = "üìä –°–í–û–î–ù–´–ô –û–¢–ß–ï–¢ [" + new Date().toLocaleDateString() + "]\n\n";
    const getTxt = (cat, title, unit) => {
        let d = {}; if(data[cat]) Object.values(data[cat]).forEach(v => d[v.name] = (d[v.name] || 0) + v.amount);
        let items = Object.keys(d).filter(k => Math.abs(d[k]) > 0.1).sort();
        if(items.length) { txt += title + ":\n"; items.forEach(k => txt += `- ${k}: ${Math.round(d[k])} ${unit}\n`); txt += "\n"; }
    };
    getTxt('–ì–æ—Ç–æ–≤–∞—è', 'üì¶ –§–ê–°–û–í–ö–ê', '—à—Ç'); getTxt('Stock_DV', 'üè≠ –°–ö–õ–ê–î –î–í', '–∫–≥'); getTxt('WeightStock', '‚öñÔ∏è –ü–û–ö–£–ü–ù–ê–Ø', '–∫–≥');
    if (navigator.share) { navigator.share({ title: '–û—Ç—á–µ—Ç', text: txt }).catch(console.error); } 
    else { navigator.clipboard.writeText(txt).then(() => alert('–û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –í—Å—Ç–∞–≤—å—Ç–µ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä.')).catch(e => alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è')); }
}

function renderByTiles(c, rawD, type) {
    const gr = {};
    if(rawD) Object.entries(rawD).forEach(([id,v])=>{
        if(!v.date) return;
        const dObj = new Date(v.date);
        const y = dObj.getFullYear(), m = dObj.getMonth(); 
        if(!gr[y]) gr[y] = {};
        if(!gr[y][m]) gr[y][m] = [];
        gr[y][m].push({...v, id});
    });

    let h = '';
    Object.keys(gr).sort((a,b)=>b-a).forEach(y => {
        h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('y${y}${type}')">${y}</div></div><div id="y${y}${type}" class="arch-content">`;
        h+=`<div class="arch-m-grid">`;
        Object.keys(gr[y]).sort((a,b)=>b-a).forEach(m=>{ h+=`<div class="arch-tile-m" onclick="toggleF('m${y}${m}${type}')">${mths[m]}</div>`; });
        h+=`</div>`; 
        Object.keys(gr[y]).sort((a,b)=>b-a).forEach(m=>{
             h+=`<div id="m${y}${m}${type}" class="arch-content" style="grid-column:1/-1;">`;
             gr[y][m].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v => {
                if(type==='FAS') h+=`<div class="card"><button class="del-rep-btn" onclick="event.stopPropagation();delFasFull('${v.id}')">üóëÔ∏è</button><b>${v.name.toUpperCase()}</b> [${fd2(v.date)}]<div class="report-line"><span>–°—ã—Ä—å–µ:</span><b>${v.prihod}–∫–≥ [${v.rawItem}]</b></div><div class="report-line"><span>–í—ã—Ö–æ–¥:</span><b>${v.vyhod}—à—Ç</b></div><div class="report-line"><span>–ü–∞–∫–µ—Ç—ã:</span><b>${v.size} [${pk(v.vyhod, v.name)}—à—Ç]</b></div><div class="report-line"><span>–ü–ª–µ–Ω–∫–∞:</span><b>${pl(v.vzial, v.ostatok)}–∫–≥</b></div><div class="report-line"><span>–°–∫–æ—Ç—á:</span><b>${v.scotch||0} —à—Ç</b></div></div>`;
                else if(type==='KRUP' || type==='VIBRO' || type==='ZSHM') {
                    let ts = (v.timeStart||'??') + ' ‚Äî ' + (v.timeEnd||'??');
                    h+=`<div class="card"><button class="del-rep-btn" onclick="event.stopPropagation();delWorkshopReportFull('${WS_CFG[type].db}', '${v.id}')">üóëÔ∏è</button><b>${WS_CFG[type].title}</b> [${fd2(v.date)}]` + `<div style="font-size:11px;color:#333;margin-bottom:5px;font-weight:bold">üïë ${ts}</div>` + `<div style="font-size:11px;color:#333;margin-bottom:5px">üë§ ${v.operator||'-'} / ${v.assistant||'-'}</div>` + `<div style="font-size:11px;color:#64748b">${v.rawMix}</div><hr style="opacity:0.2">` + v.items.map(i=>`<div class="report-line"><span>${i.n}</span><b>${i.q}–º [${i.w}–∫–≥]</b></div>`).join('') + `</div>`;
                }
             });
             h+=`</div>`;
        });
        h+=`</div>`;
    });
    c.innerHTML = h || '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π';
}

const pk = (v,n) => Math.round(Math.abs(v/((n==="–ö—É—Ç—è")?19.8:9.9)));
const pl = (v,o) => Math.abs((v||0)-(o||0)).toFixed(1);

function rFas(c) { renderByTiles(c, data.–§–∞—Å–æ–≤–∫–∞, 'FAS'); }
function rKrup(c) { renderByTiles(c, data.Krup_Report, 'KRUP'); }
function rVibro(c) { renderByTiles(c, data.Vibro_Report, 'VIBRO'); }
function rZSHM(c) { renderByTiles(c, data.ZSHM_Report, 'ZSHM'); }
function rArchPack(c){ const d = data.ArchPackIn || {}; const gr = {}; if(d) Object.entries(d).forEach(([id,v])=>{ if(!v.date) return; const dObj = new Date(v.date); const y = dObj.getFullYear(), m = dObj.getMonth(), dy = dObj.getDate(); if(!gr[y]) gr[y] = {}; if(!gr[y][m]) gr[y][m] = []; gr[y][m].push({...v, id}); }); let h=''; Object.keys(gr).sort((a,b)=>b-a).forEach(y=>{ h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('py${y}')">${y}</div></div><div id="py${y}" class="arch-content">`; h+=`<div class="arch-m-grid">`;Object.keys(gr[y]).sort((a,b)=>b-a).forEach(m=>{ h+=`<div class="arch-tile-m" onclick="toggleF('pm${y}${m}')">${mths[m]}</div>`; }); h+=`</div>`; Object.keys(gr[y]).sort((a,b)=>b-a).forEach(m=>{ h+=`<div id="pm${y}${m}" class="arch-content">`; gr[y][m].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{ h+=`<div class="arch-inv"><div><b>${(v.num||'–ë/–ù')}</b>${v.name} (${v.amount}–∫–≥)</div><div style="font-size:10px;color:#888">${v.supplier||'-'}</div></div>`; }); h+=`</div>`; }); h+=`</div>`; }); c.innerHTML=h||'–ü—É—Å—Ç–æ'; }
function rWH(c){const t={};gP('–ì–æ—Ç–æ–≤–∞—è').forEach(p=>t[p]=0);if(data.–ì–æ—Ç–æ–≤–∞—è)Object.values(data.–ì–æ—Ç–æ–≤–∞—è).forEach(v=>t[v.name]+=v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('–ì–æ—Ç–æ–≤–∞—è','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','–ì–æ—Ç–æ–≤–∞—è','${n}')">¬±</button></div>`;});c.innerHTML=h+'</div>';}
function rWgh(c){const t={};gP('WeightStock').forEach(p=>t[p]=0);if(data.WeightStock)Object.values(data.WeightStock).forEach(v=>t[v.name]+=v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('WeightStock','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','WeightStock','${n}')">¬±</button></div>`;});c.innerHTML=h+'</div>';}
function rRaw(c){const t={};gP('Stock_Raw').forEach(p=>t[p]=0);if(data.Stock_Raw)Object.values(data.Stock_Raw).forEach(v=>t[v.name]+=v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{h+=`<div class="item-card ${t[n]<0?'alarm-blink':''}"><div class="item-title">${n}</div><div class="item-qty">${Math.round(t[n])}</div><button class="history-btn" onclick="showH('Stock_Raw','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','Stock_Raw','${n}')">¬±</button></div>`;});c.innerHTML=h+'</div>';}
function rGen(c){const d=data[cur]||{},t={},u='–∫–≥';Object.values(d).forEach(v=>{let k=v.name;if(k)t[k]=(t[k]||0)+v.amount});let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(k=>{const val=t[k];let alarm=val<0;if(cur==='–ü–ª–µ–Ω–∫–∞'&&val<50)alarm=true;if(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'&&val<30)alarm=true;if(cur==='–ü–∞–∫–µ—Ç—ã'&&val<3000)alarm=true;h+=`<div class="item-card ${alarm?'alarm-blink':''}"><div class="item-title">${k}</div><div class="item-qty">${cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'?val.toFixed(1):Math.round(val)} <small style="font-size:10px">${u}</small></div><button class="history-btn" onclick="showH('${cur}','${k}')">üìú</button><button class="corr-btn" onclick="openModal('corr','${cur}','${k}')">¬±</button></div>`;});c.innerHTML=h+'</div>';}

function showH(c, k) {
    const ti = document.getElementById('mT'), b = document.getElementById('mB');
    ti.innerText = k;
    const hist = [];
    if (data[c]) Object.entries(data[c]).filter(([id, v]) => v.name === k).forEach(([id, v]) => {
        let n = v.note || '–ó–∞–ø–∏—Å—å';
        if (v.supplier) n = '–ü—Ä–∏—Ö–æ–¥: ' + v.supplier;
        if (v.client) n = '–û—Ç–≥—Ä—É–∑–∫–∞: ' + v.client;
        hist.push({ d: v.date, ts: v.ts || '', n: n, a: v.amount, id: id, isFix: v.isFix });
    });
    hist.sort((a, b) => (a.d + a.ts).localeCompare(b.d + b.ts));
    const curMonthKey = new Date().toISOString().slice(0, 7); 
    const archives = {};
    const currentList = [];
    hist.forEach(v => {
        const vMonth = v.d.slice(0, 7);
        if (vMonth === curMonthKey) currentList.push(v);
        else { if (!archives[vMonth]) archives[vMonth] = []; archives[vMonth].push(v); }
    });
    currentList.sort((a,b)=>(b.d+b.ts).localeCompare(a.d+a.ts));
    let h = '<div style="margin-top:10px">';
    const sortedMonths = Object.keys(archives).sort().reverse();
    if(sortedMonths.length > 0) {
        h += `<div class="arch-y-grid" style="margin-bottom:15px">`;
        sortedMonths.forEach(mKey => {
            const [yr, mn] = mKey.split('-');
            const mName = mths[parseInt(mn)-1];
            h += `<div class="arch-tile-y" style="font-size:12px;padding:15px 5px;background:#f1f5f9;color:#64748b;box-shadow:none;border:1px solid #cbd5e1" onclick="toggleF('h_${mKey}')">üìÅ ${mName} ${yr}</div>`;
        });
        h += `</div>`;
        sortedMonths.forEach(mKey => {
            h += `<div id="h_${mKey}" class="arch-content" style="border-left:2px solid #ccc;padding-left:10px;margin-bottom:10px">`;
            archives[mKey].sort((a,b)=>(b.d+b.ts).localeCompare(a.d+a.ts)).forEach(v => { h += renderHistRow(c, v); });
            h += `</div>`;
        });
    }
    if(currentList.length > 0) {
        h += `<div style="font-size:10px;color:#94a3b8;font-weight:800;margin-bottom:5px;text-transform:uppercase">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü (${mths[new Date().getMonth()]})</div>`;
        h += `<div style="display:flex;flex-direction:column;gap:0;">`;
        currentList.forEach(v => { h += renderHistRow(c, v, false); });
        h += '</div>';
    } else { h += `<div style="text-align:center;padding:20px;color:#94a3b8;font-size:12px">–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –æ–ø–µ—Ä–∞—Ü–∏–π –µ—â–µ –Ω–µ –±—ã–ª–æ</div>`; }
    h += '</div>';
    b.innerHTML = h;
    document.getElementById('mdl').style.display = 'flex';
}

function renderHistRow(c, v, isTable=false) {
    if(v.isFix) {
        return `<div style="background:#fffbeb;padding:10px;border-radius:8px;margin:5px 0;font-size:12px;color:#92400e;display:flex;justify-content:space-between;align-items:center;border:1px solid #fcd34d;">
            <span style="font-weight:700">üìå ${v.n}</span>
            <span style="font-size:10px;color:#b45309">${fd2(v.d)}</span>
            ${corrMode ? `<button onclick="delRec('${c}','${v.id}')" style="border:none;background:none;font-size:14px;margin-left:5px">üóëÔ∏è</button>` : ''}
        </div>`;
    }
    const html = `<div style="padding:8px 0;width:60%">
            <div style="font-weight:600;color:#1e293b;font-size:13px">${v.n}</div>
            <div style="font-size:10px;color:#94a3b8">${fd2(v.d)}</div>
        </div>
        <div style="text-align:right;font-weight:800;font-size:14px;width:30%" class="${v.a >= 0 ? 'hist-pos' : 'hist-neg'}">
            ${c === '–ü–∞–∫–µ—Ç—ã' ? Math.round(v.a) : v.a.toFixed(1)}
        </div>
        <div style="width:30px;text-align:center">
            ${corrMode ? `<button onclick="delRec('${c}','${v.id}')" style="border:none;background:none;font-size:16px;color:red">üóëÔ∏è</button>` : ''}
        </div>`;
    return `<div style="display:flex;align-items:center;border-bottom:1px solid #f1f5f9;justify-content:space-between;padding:2px 0">${html}</div>`;
}

async function sFixBal() {
    const dVal = document.getElementById('fixDate').value;
    if(!dVal) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!');
    const dStart = dVal + "T00:00:00.000Z";
    const cats = ['Stock_DV', 'Stock_Semi', 'Stock_Feed', 'Stock_Raw', 'WeightStock', '–ì–æ—Ç–æ–≤–∞—è', '–ü–∞–∫–µ—Ç—ã', '–ü–ª–µ–Ω–∫–∞', '–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º', '–ú–µ—à–∫–∏', '–ù–∏—Ç–∫–∏', '–≠—Ç–∏–∫–µ—Ç–∫–∞'];
    const updates = {};
    let count = 0;
    const btn = document.getElementById('btnFix');
    btn.disabled = true; btn.innerText = "–°–û–•–†–ê–ù–Ø–Æ...";
    cats.forEach(cat => {
        if(!data[cat]) return;
        const sums = {};
        Object.values(data[cat]).forEach(v => sums[v.name] = (sums[v.name]||0) + v.amount);
        Object.keys(sums).forEach(name => {
            const amount = sums[name];
            if(Math.abs(amount) > 0.01) {
                const key = db.child(cat).push().key;
                updates[`/${cat}/${key}`] = { name: name, amount: 0, date: dStart, ts: dStart, note: `üü¢ –û–°–¢–ê–¢–û–ö: ${Math.round(amount)}`, isFix: true };
                count++;
            }
        });
    });
    try { await db.update(updates); alert(`–ì–æ—Ç–æ–≤–æ! –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ ${count} –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –¥–∞—Ç—É ${dVal}`); closeModal(); } 
    catch(e) { alert("–û—à–∏–±–∫–∞: " + e); btn.disabled = false; btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨"; }
}

function rInvD(c){ 
    const dbK=(archSub==='In'?'ArchIncoming':'ArchInvoices'),d=data[dbK]||{},t={}; 
    Object.entries(d).forEach(([id,v])=>{ if(!v.date) return; const dt=new Date(v.date),y=dt.getFullYear(),m=dt.getMonth(); if(!t[y])t[y]={m:{}}; if(!t[y].m[m])t[y].m[m]=[]; t[y].m[m].push({...v,id}); }); 
    let h=''; 
    Object.keys(t).sort((a,b)=>b-a).forEach(y=>{ 
        h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('y${y}')">${y}</div></div><div id="y${y}" class="arch-content">`; 
        h+=`<div class="arch-m-grid">`; 
        Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{ h+=`<div class="arch-tile-m" onclick="toggleF('m${y}${m}')">${mths[m]}</div>`; }); 
        h+=`</div>`; 
        Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{ 
            h+=`<div id="m${y}${m}" class="arch-content" style="grid-column:1/-1;">`; 
            t[y].m[m].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{ 
                if(dbK==='ArchIncoming'){ 
                    h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–û–î</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.supplier}</div><div class="j-body">`; 
                    if(v.items)v.items.forEach(i=>h+=`<div class="j-row"><span class="j-dots">${i.n}</span><span class="j-val">${i.w}–∫–≥</span></div>`); 
                    else h+=`<div class="j-row"><span class="j-dots">${v.name}</span><span class="j-val">${v.amount}–∫–≥</span></div>`; 
                    h+=`</div>`; 
                    if(corrMode)h+=`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${dbK}','${v.id}')">–£–î–ê–õ–ò–¢–¨ –ò –û–¢–ú–ï–ù–ò–¢–¨</button>`; 
                    h+=`</div>`; 
                } else { 
                    h+=`<div class="j-card"><div class="j-head">–û–¢–ì–†–£–ó–ö–ê</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.client}</div><div class="j-body">`; 
                    if(v.items)v.items.forEach(i=>h+=drawShipItem(i)); 
                    h+=`</div>`; 
                    if(corrMode)h+=`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${dbK}','${v.id}')">–£–î–ê–õ–ò–¢–¨ –ò –í–ï–†–ù–£–¢–¨</button>`; 
                    h+=`</div>`; 
                } 
            }); 
            h+=`</div>`; 
        }); 
        h+=`</div>`; 
    }); 
    c.innerHTML=h||'–ü—É—Å—Ç–æ'; 
}

function rInvC(c){ 
    const dbK=(archSub==='In'?'ArchIncoming':'ArchInvoices'),d=data[dbK]||{},t={}; 
    Object.entries(d).forEach(([id,v])=>{ if(!v.date) return; const dt=new Date(v.date),y=dt.getFullYear(),m=dt.getMonth(); const clName=v.client||v.supplier||'–ë–µ–∑ –∏–º–µ–Ω–∏'; if(!t[y])t[y]={m:{}}; if(!t[y].m[m])t[y].m[m]={cl:{}}; if(!t[y].m[m].cl[clName])t[y].m[m].cl[clName]=[]; t[y].m[m].cl[clName].push({...v,id}); }); 
    let h=''; 
    Object.keys(t).sort((a,b)=>b-a).forEach(y=>{ 
        h+=`<div class="arch-y-grid"><div class="arch-tile-y" onclick="toggleF('cy${y}')">${y}</div></div><div id="cy${y}" class="arch-content">`; 
        h+=`<div class="arch-m-grid">`; 
        Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{ h+=`<div class="arch-tile-m" onclick="toggleF('cm${y}${m}')">${mths[m]}</div>`; }); 
        h+=`</div>`; 
        Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{ 
            h+=`<div id="cm${y}${m}" class="arch-content" style="grid-column:1/-1;">`; 
            
            Object.keys(t[y].m[m].cl).sort().forEach(cl=>{ 
                const safeCl = cl.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å]/g, '');
                const uniqueId = `c${y}${m}${safeCl}`;
                const count = t[y].m[m].cl[cl].length;
                h+=`<div class="arch-tile-c" style="margin-bottom:2px" onclick="toggleF('${uniqueId}')">${cl}<div class="arch-badge">${count}</div></div>`;
                h+=`<div id="${uniqueId}" class="arch-content" style="margin-bottom:10px; border-left: 2px solid var(--p); padding-left: 5px;">`;
                t[y].m[m].cl[cl].sort((a,b)=>(b.date+b.ts).localeCompare(a.date+a.ts)).forEach(v=>{ 
                    if(dbK==='ArchIncoming'){ 
                        h+=`<div class="j-card"><div class="j-head" style="color:var(--s)">–ü–†–ò–•–û–î</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.supplier}</div><div class="j-body">`; 
                        if(v.items)v.items.forEach(i=>h+=`<div class="j-row"><span class="j-dots">${i.n}</span><span class="j-val">${i.w}–∫–≥</span></div>`); 
                        else h+=`<div class="j-row"><span class="j-dots">${v.name}</span><span class="j-val">${v.amount}–∫–≥</span></div>`; 
                        h+=`</div>`;
                        if(corrMode)h+=`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${dbK}','${v.id}')">–£–î–ê–õ–ò–¢–¨ –ò –û–¢–ú–ï–ù–ò–¢–¨</button>`;
                        h+=`</div>`; 
                    } else { 
                        h+=`<div class="j-card"><div class="j-head">–û–¢–ì–†–£–ó–ö–ê</div><div class="j-sub">${fd2(v.date)} ‚Ññ${v.num||'–ë/–ù'}</div><div class="j-title">${v.client}</div><div class="j-body">`; 
                        if(v.items)v.items.forEach(i=>h+=drawShipItem(i)); 
                        h+=`</div>`;
                        if(corrMode)h+=`<button class="btn-main" style="background:#fee2e2;color:red;margin-top:5px;padding:8px" onclick="event.stopPropagation();delInvoiceFull('${dbK}','${v.id}')">–£–î–ê–õ–ò–¢–¨ –ò –í–ï–†–ù–£–¢–¨</button>`;
                        h+=`</div>`; 
                    } 
                }); 
                h+=`</div>`; 
            }); 
            h+=`</div>`; 
        }); 
        h+=`</div>`; 
    }); 
    c.innerHTML=h||'–ü—É—Å—Ç–æ'; 
}

function makeSelect(id, cat, ph, sourceOverride, newLabel) { let opts = `<option value="">${ph}...</option>`; let list = []; if(sourceOverride) list = sourceOverride; else { if(cat === 'Stock_DV') { const rawSet = new Set(); gP(cat).forEach(full => rawSet.add(full.split(' [')[0])); list = Array.from(rawSet).sort(); } else { list = gP(cat); } } list.forEach(n => opts += `<option value="${n}">${n}</option>`); opts += `<option value="NEW" style="font-weight:bold;color:var(--p)">${newLabel || '+ –ù–û–í–´–ô –í–ò–î'}</option>`; return `<select id="s_${id}" onchange="toggleInput('${id}')" style="width:100%">${opts}</select><input type="text" id="i_${id}" class="new-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" style="display:none;width:100%">`; }
function makeSmart(id, list, ph) { let opts = `<option value="">${ph}</option>`; if(list) list.forEach(x => opts += `<option value="${x}">${x}</option>`); opts += `<option value="NEW_ENTRY" style="font-weight:900;color:blue">(+) –í–í–ï–°–¢–ò...</option>`; return `<div class="smart-wrap"> <select id="s_${id}" class="smart-sel" onchange="checkSmart('${id}')">${opts}</select> <input type="text" id="i_${id}" class="smart-inp" placeholder="${ph}"> </div>`; }
function checkSmart(id) { const sel = document.getElementById('s_' + id); if(sel.value === 'NEW_ENTRY') { sel.style.display = 'none'; const inp = document.getElementById('i_' + id); inp.style.display = 'block'; inp.focus(); } }
function getSmartVal(id) { const i = document.getElementById('i_' + id); if(i && i.style.display === 'block') return i.value; const s = document.getElementById('s_' + id); return s ? s.value : ''; }
function getHistoryDeep(key) { const s = new Set(); const scan = (node) => { if(data[node]) Object.values(data[node]).forEach(v => { if(v[key]) s.add(v[key]); if(v.items && Array.isArray(v.items)) { v.items.forEach(i => { if(key === 'weight' && i.w) s.add(i.w); if(key === 'name' && i.n) s.add(i.n); }); } }); }; scan('Vibro_Report'); scan('Krup_Report'); scan('ZSHM_Report'); return Array.from(s).sort(); }

function openModal(t, a1, a2){
    const ti=document.getElementById('mT'),b=document.getElementById('mB');
    const td = new Date().toISOString().split('T')[0];
    aId = null; 
    
    if(WS_CFG[t]) {
        renderWorkshopModal(t, ti, b, td);
        document.getElementById('mdl').style.display='flex';
        return;
    }

    if(arguments.length === 2 && (t!=='corr')) aId = a1;

    if(t==='corr'){
        const cat = a1; 
        const name = a2;
        corrCtx = {cat, name};
        ti.innerText='–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: '+name;
        b.innerHTML=`
            <div style="margin-bottom:15px;background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #e2e8f0">
                <div style="font-size:10px;color:#64748b;font-weight:700;margin-bottom:5px">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–†–¢–û–ß–ö–û–ô</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px">
                    <button class="btn-main" style="background:#fff;color:#333;border:1px solid #cbd5e1;padding:8px;font-size:11px" onclick="renameItem('${name}','${cat}')">‚úèÔ∏è –ò–ú–Ø</button>
                    <button class="btn-main" style="background:#fee2e2;color:red;border:1px solid #fca5a5;padding:8px;font-size:11px" onclick="delItemBatch('${name}','${cat}')">üóëÔ∏è –£–î–ê–õ–ò–¢–¨</button>
                </div>
            </div>
            <hr style="border:none;border-top:1px dashed #cbd5e1;margin:10px 0">
            <label class="l-t">–î–ê–¢–ê –û–ü–ï–†–ê–¶–ò–ò</label>
            <input type="date" id="cD" value="${td}">
            <label class="l-t">–ò–ó–ú–ï–ù–ò–¢–¨ –û–°–¢–ê–¢–û–ö (+/-)</label>
            <div style="display:flex;gap:5px">
                <input type="number" id="cA" placeholder="0">
                <button onclick="document.getElementById('cA').value *= -1" style="width:50px;font-weight:900;background:#eef2ff;border:1px solid #cbd5e1;border-radius:10px">+/-</button>
            </div>
            <label class="l-t">–ü–†–ò–ß–ò–ù–ê</label>
            <input type="text" id="cR" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–µ—Ä–µ—É—á–µ—Ç">
            <button class="btn-main" id="btnS" onclick="sCorr()" style="margin-top:10px">–°–û–•–†–ê–ù–ò–¢–¨</button>
        `;
    }
    else if(t==='fas'){
        let rL = []; gP('WeightStock').forEach(x => rL.push(`${x} (–ü–æ–∫—É–ø–Ω–∞—è)`)); gP('Stock_DV').forEach(x => rL.push(`${x} (–°–∫–ª–∞–¥ –î–í)`)); rL.sort();
        ti.innerText='–§–∞—Å–æ–≤–∫–∞';
        b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="fD" value="${td}">–ö—Ä—É–ø–∞:<select id="fN">${gP('–ì–æ—Ç–æ–≤–∞—è').map(p=>`<option>${p}</option>`).join('')}</select>–°–ø–∏—Å–∞—Ç—å:<select id="fRaw">${rL.map(p=>`<option>${p}</option>`).join('')}</select>–ü–∞–∫–µ—Ç:<select id="fS">${szs.map(s=>`<option>${s}</option>`).join('')}</select><input type="number" id="fP" placeholder="–°—ã—Ä—å–µ –∫–≥"><input type="number" id="fV" placeholder="–í—ã—Ö–æ–¥ —à—Ç"><input type="text" id="fVz" placeholder="–í–∑—è–ª –ø–ª–µ–Ω–∫–∏ (—á–µ—Ä–µ–∑ +)"><input type="number" id="fOs" placeholder="–û—Å—Ç–∞—Ç–æ–∫ –ø–ª–µ–Ω–∫–∏"><button class="btn-main" id="btnS" onclick="sFas()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;
    }
    else if(t==='addRaw'){
        ti.innerText='–ü—Ä–∏—Ö–æ–¥ –°—ã—Ä—å—è';
        // –î–û–ë–ê–í–ò–õ –ü–û–õ–ï –í–í–û–î–ê –î–ê–¢–´ (id="rD")
        b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="rD" value="${td}">–ù–∞–∑–≤–∞–Ω–∏–µ:${makeSelect('rN','Stock_Raw','–ù–∞–∑–≤–∞–Ω–∏–µ')}–ü–æ—Å—Ç–∞–≤—â–∏–∫:${makeSelect('rSupp','','–ü–æ—Å—Ç–∞–≤—â–∏–∫',gRawActive(),'+ –ù–û–í–´–ô –ü–û–°–¢–ê–í–©–ò–ö')}–í–µ—Å (–∫–≥):<input type="number" id="rA"><button class="btn-main" id="btnS" onclick="sRawInc()">–ü–†–ò–ù–Ø–¢–¨</button>`;
    }
    else if(t==='inc'){
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º gBuyS() –¥–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
        b.innerHTML=`<div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:5px"><div><label class="l-t">–î–ê–¢–ê</label><input type="date" id="iD" value="${td}"></div><div><label class="l-t">‚Ññ –ù–ê–ö–õ</label><input type="text" id="iNum" placeholder="‚Ññ"></div></div><div style="margin-bottom:5px"><label class="l-t">–ü–û–°–¢–ê–í–©–ò–ö</label>${makeSelect('iS','ArchIncoming','–ü–æ—Å—Ç–∞–≤—â–∏–∫',gBuyS(),'+ –ù–û–í–´–ô')}</div><div style="margin-bottom:5px"><label class="l-t">–ù–ê–ò–ú–ï–ù–û–í–ê–ù–ò–ï</label>${makeSelect('iN','WeightStock','–¢–æ–≤–∞—Ä',gP('WeightStock'),'+ –ù–û–í–´–ô')}</div><div style="margin-bottom:15px"><label class="l-t">–í–ï–° (–ö–ì)</label><input type="number" id="iA" placeholder="0"></div><button class="btn-main" style="background:var(--s)" onclick="sInc()">–ü–†–ò–ù–Ø–¢–¨ –ù–ê –°–ö–õ–ê–î –ü–û–ö–£–ü–ù–ê–Ø</button>`;
    }
    else if(t==='addMatPack'){
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º gPackS() –¥–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
        b.innerHTML=`<input type="date" id="pD" value="${td}">${makeSelect('pS','ArchPackIn','–ü–æ—Å—Ç–∞–≤—â–∏–∫',gPackS(),'+ –ù–û–í–´–ô')}${makeSelect('pN','–ü–∞–∫–µ—Ç—ã','–í–∏–¥',gPack('–ü–∞–∫–µ—Ç—ã'))}<input type="number" id="pA" placeholder="–ö–æ–ª-–≤–æ"><button class="btn-main" style="margin-top:10px;background:var(--s)" onclick="sPack()">–ü–†–ò–ù–Ø–¢–¨</button>`;
    }
    else if(t==='ship'){
        b.innerHTML=`<div class="grid" style="grid-template-columns:2fr 1fr"><div class="col"><label class="lt">–î–ê–¢–ê</label><input type="date" id="hD" value="${td}"></div><div class="col"><label class="lt">‚Ññ –ù–ê–ö–õ</label><input type="text" id="hNum" placeholder="‚Ññ"></div></div><div style="margin:5px 0"><label class="lt">–ö–õ–ò–ï–ù–¢</label>${makeSelect('hC', 'ArchInvoices', '–ö–ª–∏–µ–Ω—Ç', gCl(), '+ –ù–û–í–´–ô')}</div><div class="z-head">–û–¢–ö–£–î–ê –ì–†–£–ó–ò–ú:</div><div class="dash-grid" style="margin-bottom:10px;grid-template-columns:1fr 1fr"><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('–ì–æ—Ç–æ–≤–∞—è')">–§–ê–°–û–í–ö–ê</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('WeightStock')">–ü–û–ö–£–ü–ù–ê–Ø</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('Stock_DV')">–î–í</button><button class="btn-main" style="background:#fff;color:#333;border:1px solid #ccc;padding:8px" onclick="loadBulk('Stock_Feed')">–ö–û–†–ú–ê</button></div><div id="shpR"></div><button class="btn-main" id="btnS" onclick="sShip()" style="margin-top:15px;background:var(--d)">–û–¢–ì–†–£–ó–ò–¢–¨</button>`;
    }
    else if(t==='fixBal') { ti.innerText='–§–∏–∫—Å–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤'; b.innerHTML=`<p style="font-size:12px;color:#666">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ –∫–∞–∫ "–í—Ö–æ–¥—è—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫" –Ω–∞ –Ω–∞—á–∞–ª–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è?</p><input type="date" id="fixDate" value="${td}"><button class="btn-main" id="btnFix" onclick="sFixBal()" style="background:#f59e0b">–°–û–•–†–ê–ù–ò–¢–¨ –ú–ï–¢–ö–£</button>`; }
    else if(t==='dayRep') { 
        ti.innerText = '–î–Ω–µ–≤–Ω–æ–π –æ—Ç—á–µ—Ç';
        b.innerHTML = `<label class="l-t">–í–´–ë–ï–†–ò–¢–ï –î–ê–¢–£</label><input type="date" id="repDate" value="${td}" style="margin-bottom:15px"><button class="btn-main" onclick="genDayReport()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨</button>`;
    }
    document.getElementById('mdl').style.display='flex';
}

function genDayReport() {
    const dVal = document.getElementById('repDate').value;
    if(!dVal) return;
    const dateStr = dVal.split('-').reverse().join('.');
    const rep = { inc: [], out: {}, used: {}, prod: {}, pack: {} };
    if(data.ArchIncoming) Object.values(data.ArchIncoming).forEach(v => {
        if(v.date && v.date.startsWith(dVal)) rep.inc.push(`${v.name} (${v.supplier}) ${v.amount}–∫–≥`);
    });
    if(data.ArchPackIn) Object.values(data.ArchPackIn).forEach(v => {
        if(v.date && v.date.startsWith(dVal)) rep.inc.push(`${v.name} (${v.supplier}) ${v.amount}—à—Ç`);
    });
    if(data.ArchInvoices) Object.values(data.ArchInvoices).forEach(v => {
        if(v.date && v.date.startsWith(dVal)) {
            v.items.forEach(i => {
                let parts = i.split('|');
                if(parts.length < 2 && i.includes(':')) parts = i.split(':');
                let name = parts[0], am = parseFloat(parts[1]) || 0, u = parts[2] || '–∫–≥';
                if(!rep.out[name]) rep.out[name] = {val:0, u:u};
                rep.out[name].val += am;
            });
        }
    });
    const addUsed = (n, a, u) => { if(!n)return; if(!rep.used[n]) rep.used[n]={val:0,u:u}; rep.used[n].val += a; };
    const addProd = (n, a, u) => { if(!n)return; if(!rep.prod[n]) rep.prod[n]={val:0,u:u}; rep.prod[n].val += a; };
    if(data.–§–∞—Å–æ–≤–∫–∞) Object.values(data.–§–∞—Å–æ–≤–∫–∞).forEach(v => {
        if(v.date && v.date.startsWith(dVal)) {
            addUsed(v.rawItem, parseFloat(v.prihod), '–∫–≥'); 
            addProd(v.name, parseFloat(v.vyhod), '—à—Ç'); 
        }
    });
    ['Vibro_Report', 'Krup_Report', 'ZSHM_Report'].forEach(dbName => {
        if(data[dbName]) Object.values(data[dbName]).forEach(v => {
            if(v.date && v.date.startsWith(dVal)) {
                if(v.rawMix) {
                    let cleanMix = v.rawMix;
                    let match = cleanMix.match(/^(.*)\s\((\d+(\.\d+)?)–∫–≥\)$/);
                    if(match) { addUsed(match[1], parseFloat(match[2]), '–∫–≥'); }
                    else { addUsed(cleanMix, 0, ''); }
                }
                if(v.items) v.items.forEach(i => {
                    let wTotal = (i.q * i.w) + i.l;
                    addProd(i.n, wTotal, '–∫–≥');
                });
            }
        });
    });
    const packCats = ['–ü–∞–∫–µ—Ç—ã', '–ü–ª–µ–Ω–∫–∞', '–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º', '–ú–µ—à–∫–∏', '–ù–∏—Ç–∫–∏', '–≠—Ç–∏–∫–µ—Ç–∫–∞'];
    packCats.forEach(cat => {
        if(data[cat]) Object.values(data[cat]).forEach(v => {
            if(v.date && v.date.startsWith(dVal) && v.amount < 0) {
                let n = v.name;
                let u = (cat === '–ü–ª–µ–Ω–∫–∞') ? '–∫–≥' : '—à—Ç';
                if(!rep.pack[n]) rep.pack[n] = {val:0, u:u};
                rep.pack[n].val += Math.abs(v.amount);
            }
        });
    });
    const red = (txt) => `<span style="color:#ef4444">${txt}</span>`;
    let h = `<div class="day-rep-box">–û—Ç—á—ë—Ç –∑–∞ ${dateStr}`;
    h += `<div class="dr-h">–ü—Ä–∏—Ö–æ–¥:</div>`;
    if(rep.inc.length) rep.inc.forEach(l => h += `+ ${l}\n`); else h += `-\n`;
    h += `<div class="dr-h">–û—Ç–≥—Ä—É–∂–µ–Ω–æ:</div>`;
    let outKeys = Object.keys(rep.out).sort();
    if(outKeys.length) outKeys.forEach(k => h += red(`- ${k} ${parseFloat(rep.out[k].val.toFixed(1))}${rep.out[k].u}`) + `\n`); else h += `-\n`;
    h += `<div class="dr-h">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–æ:</div>`;
    let usedKeys = Object.keys(rep.used).sort();
    if(usedKeys.length) usedKeys.forEach(k => {
        let val = rep.used[k].val;
        h += red(`- ${k} ${val > 0 ? parseFloat(val.toFixed(1)) + rep.used[k].u : ''}`) + `\n`;
    }); else h += `-\n`;
    h += `<div class="dr-h">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ:</div>`;
    let prodKeys = Object.keys(rep.prod).sort();
    if(prodKeys.length) prodKeys.forEach(k => h += `+ ${k} ${parseFloat(rep.prod[k].val.toFixed(1))}${rep.prod[k].u}\n`); else h += `-\n`;
    h += `<div class="dr-h">–£–ø–∞–∫–æ–≤–∫–∞:</div>`;
    let packKeys = Object.keys(rep.pack).sort();
    if(packKeys.length) packKeys.forEach(k => h += red(`- ${k} ${parseFloat(rep.pack[k].val.toFixed(1))}${rep.pack[k].u}`) + `\n`); else h += `-\n`;
    h += `</div>`;
    h += `<button class="btn-main" onclick="copyDayRep()" style="background:#334155">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>`;
    document.getElementById('mB').innerHTML = h;
}

function copyDayRep() {
    const el = document.querySelector('.day-rep-box');
    if(!el) return;
    navigator.clipboard.writeText(el.innerText).then(() => alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')).catch(e => alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è'));
}

function renderWorkshopModal(type, titleEl, bodyEl, today) {
    const conf = WS_CFG[type];
    const p = conf.prefix; // –ø—Ä–µ—Ñ–∏–∫—Å (v, k, z)
    titleEl.innerText = conf.title;
    const ops = getHistoryDeep('operator');
    const asts = getHistoryDeep('assistant');
    const timesS = getHistoryDeep('timeStart'); if(timesS.length===0) timesS.push('07:00'); 
    const timesE = getHistoryDeep('timeEnd'); if(timesE.length===0) timesE.push('17:00');

    bodyEl.innerHTML = `
    <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
        <div style="display:grid; grid-template-columns:1.5fr 1fr 1fr; gap:8px; margin-bottom:10px;">
            <div><label class="l-t">–î–ê–¢–ê</label><div class="smart-wrap"><input type="date" id="${p}D" value="${today}" class="smart-sel"></div></div>
            <div><label class="l-t">–°</label>${makeSmart(p+'TS', timesS, '07:00')}</div>
            <div><label class="l-t">–î–û</label>${makeSmart(p+'TE', timesE, '17:00')}</div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div><label class="l-t">–û–ü–ï–†–ê–¢–û–†</label>${makeSmart(p+'Op', ops, '–§–∞–º–∏–ª–∏—è')}</div>
            <div><label class="l-t">–ü–û–ú–û–©–ù–ò–ö</label>${makeSmart(p+'As', asts, '–§–∞–º–∏–ª–∏—è')}</div>
        </div>
    </div>
    
    <div style="background:#f9fafb;padding:8px;border-radius:8px;margin-bottom:10px;border:1px solid #eee">
        <div style="font-size:10px;color:#888;font-weight:700">–û–°–ù–û–í–ù–û–ï –°–´–†–¨–ï</div>
        <div style="display:grid; grid-template-columns:1fr 1.5fr 0.8fr; gap:5px; margin-bottom:5px;">
            <select id="${p}WH" class="smart-sel" onchange="updGenRaw('${p}')">
                <option value="Stock_Semi">–ü/–§</option>
                <option value="Stock_Raw" ${type!=='VIBRO'?'selected':''}>–°—ã—Ä—å—ë</option>
                <option value="Stock_DV">–î–í</option>
                <option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option>
            </select>
            <div id="${p}RawCont"></div> 
            <input type="number" id="${p}RawW" placeholder="–ö–≥" class="smart-sel" readonly style="background:#eef2ff;font-weight:900;color:#333">
        </div>
        <div style="font-size:10px;color:#888;font-weight:700;margin-top:5px;border-top:1px dashed #ddd;padding-top:5px">–î–û–ë–ê–í–ö–ê</div>
        <div style="display:grid; grid-template-columns:1fr 1.5fr 0.8fr; gap:5px; margin-bottom:5px;">
            <select id="${p}AddWH" class="smart-sel" onchange="updGenAdd('${p}')">
                <option value="Stock_Semi">–ü/–§</option>
                <option value="Stock_Raw">–°—ã—Ä—å—ë</option>
                <option value="Stock_DV">–î–í</option>
                <option value="WeightStock">–ü–æ–∫—É–ø–Ω–∞—è</option>
            </select>
            <div id="${p}AddNameCont"></div> 
            <input type="number" id="${p}AddW" placeholder="–ö–≥" class="smart-sel" oninput="calcGen('${p}')">
        </div>
    </div>
    <div class="z-head">–ì–û–¢–û–í–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø (–°–ö–õ–ê–î –î–í)</div>
    <div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div>
    <div id="${p}RowsDV"></div>
    <button class="btn-main" style="background:#fff; color:#3b82f6; border:1px solid #3b82f6; margin-bottom:15px; font-size:10px" onclick="addGenRow('${p}','DV')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button>
    <div class="z-head" style="color:#d97706;background:#fef3c7;">–ü–û–õ–£–§–ê–ë–†–ò–ö–ê–¢ (–°–ö–õ–ê–î –ü/–§)</div>
    <div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div>
    <div id="${p}RowsSemi"></div>
    <button class="btn-main" style="background:#fff; color:#d97706; border:1px solid #d97706; margin-bottom:15px; font-size:10px" onclick="addGenRow('${p}','Semi')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button>
    <div class="z-head" style="color:#b45309;background:#fff7ed;">–û–¢–•–û–î–´ (–°–ö–õ–ê–î –ö–û–†–ú–ê)</div>
    <div class="z-col-h"><div>–ù–ê–ó–í–ê–ù–ò–ï</div><div>–ú–ï–®</div><div>–í–ï–°</div><div>–û–°–¢</div></div>
    <div id="${p}RowsFeed"></div>
    <button class="btn-main" style="background:#fff; color:#b45309; border:1px solid #b45309; margin-bottom:15px; font-size:10px" onclick="addGenRow('${p}','Feed')">+ –î–û–ë–ê–í–ò–¢–¨ –†–Ø–î</button>
    <button class="btn-main" id="btnS" onclick="saveGen('${type}')">–°–û–•–†–ê–ù–ò–¢–¨ –°–ú–ï–ù–£</button>
    `;
    setTimeout(()=>{ updGenRaw(p); updGenAdd(p); addGenRow(p, 'DV'); addGenRow(p, 'Semi'); addGenRow(p, 'Feed'); }, 50);
}

function updGenRaw(p) { const wh = document.getElementById(p+'WH').value; let list = Array.from(new Set(gP(wh))).sort(); document.getElementById(p+'RawCont').innerHTML = makeSmart(p+'RawItem', list, '–°—ã—Ä—å–µ'); }
function updGenAdd(p) { const wh = document.getElementById(p+'AddWH').value; let list = Array.from(new Set(gP(wh))).sort(); document.getElementById(p+'AddNameCont').innerHTML = makeSmart(p+'AddItem', list, '–î–æ–±–∞–≤–∫–∞'); }

function addGenRow(p, section) {
    const rid = Date.now() + Math.floor(Math.random()*1000); 
    let listSrc;
    if(section === 'DV') listSrc = gP('Stock_DV'); else if(section === 'Semi') listSrc = gP('Stock_Semi'); else listSrc = gP('Stock_Feed');
    const list = Array.from(new Set(listSrc)).sort();
    const makeRowSmart = (id) => { let opts = `<option value="">–í—ã–±—Ä–∞—Ç—å...</option>`; list.forEach(x => opts += `<option value="${x}">${x}</option>`); opts += `<option value="NEW_ENTRY" style="color:blue">(+) –ù–æ–≤—ã–π</option>`; return `<div class="smart-wrap"><select id="s_${id}" class="smart-sel" onchange="checkSmart('${id}')">${opts}</select><input type="text" id="i_${id}" class="smart-inp"></div>`; };
    const wList = getHistoryDeep('weight'); let wOpts = '<option value="">–ö–≥</option>'; wList.forEach(w => wOpts += `<option value="${w}">${w}</option>`); wOpts += '<option value="NEW_ENTRY">(+)</option>';
    const rowHTML = `<div class="dyn-row" id="${p}row_${rid}" data-sect="${section}">
        ${makeRowSmart(`${p}N_${rid}`)}
        <input type="number" id="${p}Q_${rid}" class="u-inp" placeholder="0" oninput="calcGen('${p}')">
        <div class="smart-wrap"><select id="s_${p}W_${rid}" class="smart-sel" onchange="checkSmart('${p}W_${rid}')">${wOpts}</select><input type="number" id="i_${p}W_${rid}" class="smart-inp" oninput="calcGen('${p}')"></div>
        <input type="number" id="${p}L_${rid}" class="u-inp" placeholder="–∫–≥" oninput="calcGen('${p}')">
        <button class="del-row-btn" onclick="document.getElementById('${p}row_${rid}').remove(); calcGen('${p}')">‚úï</button>
    </div>`;
    let contId = p+'RowsDV'; if(section === 'Semi') contId = p+'RowsSemi'; if(section === 'Feed') contId = p+'RowsFeed'; 
    document.getElementById(contId).insertAdjacentHTML('beforeend', rowHTML);
}

function calcGen(p) {
    let total = 0; 
    const calcContainer = (contId) => { 
        const rows = document.getElementById(contId).children; 
        for (let row of rows) { 
            const rid = row.id.split('_')[1]; 
            const q = parseFloat(document.getElementById(`${p}Q_${rid}`).value) || 0; 
            let w = parseFloat(document.getElementById(`i_${p}W_${rid}`).value); if(!w) w = parseFloat(document.getElementById(`s_${p}W_${rid}`).value) || 0; 
            const l = parseFloat(document.getElementById(`${p}L_${rid}`).value) || 0; 
            total += (q * w) + l; 
        } 
    };
    calcContainer(p+'RowsDV'); calcContainer(p+'RowsSemi'); calcContainer(p+'RowsFeed'); 
    const addW = parseFloat(document.getElementById(p+'AddW').value) || 0; 
    const res = total - addW; 
    document.getElementById(p+'RawW').value = res > 0 ? res.toFixed(1) : 0;
}

async function saveGen(type) {
    const conf = WS_CFG[type];
    const p = conf.prefix;
    const btn = document.getElementById('btnS');
    calcGen(p);
    const rawName = getSmartVal(p+'RawItem'); const rawW = parseFloat(document.getElementById(p+'RawW').value)||0;
    const addName = getSmartVal(p+'AddItem'); const addW = parseFloat(document.getElementById(p+'AddW').value)||0;
    const dV = document.getElementById(p+'D').value + "T12:00:00Z"; 
    const ts = new Date().toISOString();
    const op = getSmartVal(p+'Op'); const as = getSmartVal(p+'As'); 
    const tS = getSmartVal(p+'TS'); const tE = getSmartVal(p+'TE');
    if(!rawName || rawW <= 0) return alert('–û—à–∏–±–∫–∞: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å—ã—Ä—å–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ü–∏—é');
    const items = []; let totalProd = 0;
    const harvest = (contId, sectionType) => { 
        const rows = document.getElementById(contId).children; 
        for (let row of rows) { 
            const rid = row.id.split('_')[1]; 
            let n = getSmartVal(`${p}N_${rid}`); if(!n) continue; 
            let q = parseFloat(document.getElementById(`${p}Q_${rid}`).value) || 0; 
            let w = parseFloat(document.getElementById(`i_${p}W_${rid}`).value); if(!w) w = parseFloat(document.getElementById(`s_${p}W_${rid}`).value) || 0; 
            let l = parseFloat(document.getElementById(`${p}L_${rid}`).value) || 0; 
            if (q > 0 || l > 0) { items.push({n, q, w, l, type: sectionType}); totalProd += (q * w) + l; } 
        } 
    };
    harvest(p+'RowsDV', 'DV'); harvest(p+'RowsSemi', 'Semi'); harvest(p+'RowsFeed', 'Feed');
    if(items.length === 0) return alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—å –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –ø—Ä–æ–¥—É–∫—Ü–∏–∏');
    let rawDesc = `${rawName} (${rawW}–∫–≥)`; 
    if(addName && addW > 0) rawDesc += ` + ${addName} (${addW}–∫–≥)`;
    if(!confirm(`${conf.title}: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–º–µ–Ω—É?\n\n–í—Ö–æ–¥: ${rawDesc}\n–í—ã—Ö–æ–¥: ${totalProd.toFixed(1)}–∫–≥`)) return;
    btn.disabled = true; btn.innerText = "–°–û–•–†–ê–ù–Ø–Æ...";
    try {
        const repId = db.child(conf.db).push().key; 
        const updates = {};
        let rWH = document.getElementById(p+'WH').value; 
        updates[`/${rWH}/${db.child(rWH).push().key}`] = { name: rawName, amount: -rawW, date: dV, ts: ts, note: conf.note+' –û—Å–Ω–æ–≤–∞', fLink: repId };
        if(addName && addW > 0) { 
            let aWH = document.getElementById(p+'AddWH').value; 
            updates[`/${aWH}/${db.child(aWH).push().key}`] = { name: addName, amount: -addW, date: dV, ts: ts, note: conf.note+' –î–æ–±–∞–≤–∫–∞', fLink: repId }; 
        }
        items.forEach(i => {
            let dest = 'Stock_DV'; 
            let note = conf.note; 
            let finalName = i.n;
            if(i.type === 'DV') { 
                dest = 'Stock_DV'; 
                let cleanName = i.n.replace(/\s\[.*?\]/g, '').trim();
                finalName = (i.q > 0 ? `${cleanName} [${i.w}–∫–≥]` : cleanName); 
            } else if(i.type === 'Semi') { dest = 'Stock_Semi'; note = conf.note + ' –ü/–§'; } 
            else if(i.type === 'Feed') { dest = 'Stock_Feed'; note = conf.note + ' –û—Ç—Ö–æ–¥—ã'; }
            let amount = (i.q * i.w) + i.l; 
            updates[`/${dest}/${db.child(dest).push().key}`] = { name: finalName, amount: amount, date: dV, ts: ts, note: note, fLink: repId };
        });
        updates[`/${conf.db}/${repId}`] = { date: dV, ts: ts, link: repId, items: items, rawMix: rawDesc, timeStart: tS, timeEnd: tE, operator: op, assistant: as, type: type };
        await db.update(updates);
        closeModal();
    } catch(e) { alert("–û—à–∏–±–∫–∞: " + e); btn.disabled = false; btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨ –°–ú–ï–ù–£"; }
}

async function sCorr() {
    const btn = document.getElementById('btnS');
    const d = document.getElementById('cD').value;
    const a = parseFloat(document.getElementById('cA').value);
    const r = document.getElementById('cR').value;
    const targetCat = corrCtx.cat;
    const targetName = corrCtx.name;
    if(!a || !r) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
    btn.disabled = true; btn.innerText = "–°–û–•–†–ê–ù–Ø–Æ...";
    try {
        const dV = d + "T12:00:00Z";
        const key = db.child(targetCat).push().key;
        const updates = {};
        updates[`/${targetCat}/${key}`] = { name: targetName, amount: a, date: dV, ts: new Date().toISOString(), note: '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è: ' + r };
        await db.update(updates);
        closeModal(); 
    } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è! " + e); btn.disabled = false; btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨"; }
}

async function sFas() {
    const btn=document.getElementById('btnS');
    const d=document.getElementById('fD').value,n=document.getElementById('fN').value,rawVal=document.getElementById('fRaw').value,s=document.getElementById('fS').value;
    const v=parseFloat(document.getElementById('fV').value)||0,p=parseFloat(document.getElementById('fP').value)||0,os=parseFloat(document.getElementById('fOs').value)||0;
    let vzStr=document.getElementById('fVz').value;
    let vzTotal = vzStr.split('+').reduce((acc, val) => { let num = parseFloat(val.replace(',', '.').trim()); return acc + (isNaN(num) ? 0 : num); }, 0);
    btn.disabled = true; btn.innerText = "–°–û–•–†–ê–ù–Ø–Æ...";
    try {
        const k=(n==="–ö—É—Ç—è")?19.8:9.9; const sp=-Math.round(v/k); const plUsed=Math.abs(vzTotal-os); const scUsed=parseFloat(((v*0.12)/360).toFixed(1));
        const fId=db.child('–§–∞—Å–æ–≤–∫–∞').push().key; const ts=new Date().toISOString(); const dV=d+"T12:00:00Z";
        let srcCat='WeightStock'; let rawName = rawVal.split(' (')[0]; if(rawVal.includes('(–°–∫–ª–∞–¥ –î–í)')){srcCat='Stock_DV';}
        const updates={};
        updates['/–§–∞—Å–æ–≤–∫–∞/'+fId]={date:dV,name:n,rawItem:rawName,size:s,vyhod:v,prihod:p,vzial:vzTotal,ostatok:os,scotch:scUsed,link:fId,ts:ts};
        updates['/–ì–æ—Ç–æ–≤–∞—è/'+db.child('–ì–æ—Ç–æ–≤–∞—è').push().key]={name:n,amount:v,date:dV,note:'–§–∞—Å–æ–≤–∫–∞',fLink:fId,ts:ts};
        updates[`/${srcCat}/`+db.child(srcCat).push().key]={name:rawName,amount:-p,date:dV,note:'–§–∞—Å–æ–≤–∫–∞: '+n,fLink:fId,ts:ts};
        updates['/–ü–∞–∫–µ—Ç—ã/'+db.child('–ü–∞–∫–µ—Ç—ã').push().key]={name:s,amount:sp,date:dV,note:'(–∞–≤—Ç–æ) –§–∞—Å–æ–≤–∫–∞: '+n,fLink:fId,ts:ts};
        updates['/–ü–ª–µ–Ω–∫–∞/'+db.child('–ü–ª–µ–Ω–∫–∞').push().key]={name:n,amount:-plUsed,date:dV,note:'(–∞–≤—Ç–æ) –§–∞—Å–æ–≤–∫–∞: '+n,fLink:fId,ts:ts};
        updates['/–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º/'+db.child('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º').push().key]={name:'–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º',amount:-scUsed,date:dV,note:'(–∞–≤—Ç–æ) –§–∞—Å–æ–≤–∫–∞: '+n,fLink:fId,ts:ts};
        await db.update(updates);
        closeModal();
    } catch(e) { alert("–û—à–∏–±–∫–∞: " + e); btn.disabled = false; btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨"; }
}

function loadBulk(cat){
    const stock={}; 
    Object.values(data[cat]||{}).forEach(v=>{if(v)stock[v.name]=(stock[v.name]||0)+v.amount});
    let h=`<div class="item-grid" style="grid-template-columns:repeat(3,1fr)">`;
    Object.keys(stock).sort().forEach(n=>{
        const v=stock[n];
        if(v>0) h+=`<div class="item-card" style="padding:5px"><div class="item-title" style="height:20px">${n}</div><div style="font-size:10px;color:#888;margin-bottom:2px">–û—Å—Ç: ${Math.round(v)}</div><input type="number" class="bulk-q" data-n="${n}" data-cat="${cat}" placeholder="0" style="width:100%"></div>`;
    });
    document.getElementById('shpR').innerHTML=h+`</div>`;
}

async function sShip(){
    const sC = document.getElementById('s_hC');
    const c = (sC && sC.value === 'NEW') ? document.getElementById('i_hC').value : (sC ? sC.value : '');
    const nm=document.getElementById('hNum').value;
    const d=document.getElementById('hD').value;
    const dV=d+"T12:00:00Z";
    if(!c) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
    const its=[];
    document.querySelectorAll('.bulk-q').forEach(i=>{
        const q=parseFloat(i.value);
        if(i.value>0) its.push({n:i.getAttribute('data-n'), w:q, c:i.getAttribute('data-cat')});
    });
    if(!its.length)return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª-–≤–æ');
    if(!confirm(`–û—Ç–≥—Ä—É–∑–∏—Ç—å ${its.length} –ø–æ–∑–∏—Ü–∏–π –¥–ª—è ${c}?`)) return;
    const btn = document.getElementById('btnS'); btn.disabled=true;
    try {
        const lKey=db.child('ArchInvoices').push().key;
        const updates={};
        updates['/ArchInvoices/'+lKey]={date:dV,client:c,num:nm,items:its.map(x=>x.n+"|"+x.w+"|"+(x.c==='–ì–æ—Ç–æ–≤–∞—è'?'—à—Ç':'–∫–≥')),ts:new Date().toISOString()};
        its.forEach(i=>{ updates[`/${i.c}/${db.child(i.c).push().key}`] = {name:i.n,amount:-i.w,date:dV,note:`–û—Ç–≥—Ä: ${c} ‚Ññ${nm}`,fLink:lKey,ts:new Date().toISOString()}; });
        await db.update(updates);
        closeModal();
    } catch(e){ alert(e); btn.disabled=false; }
}

async function sInc(){
    const sS = document.getElementById('s_iS'); const s = (sS.value==='NEW')?document.getElementById('i_iS').value:sS.value;
    const sN = document.getElementById('s_iN'); const n = (sN.value==='NEW')?document.getElementById('i_iN').value:sN.value;
    const a=parseFloat(document.getElementById('iA').value);
    const num = document.getElementById('iNum').value;
    if(!a)return alert('–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å');
    if(!confirm('–ü—Ä–∏–Ω—è—Ç—å –Ω–∞ —Å–∫–ª–∞–¥ –ü–û–ö–£–ü–ù–ê–Ø?'))return;
    const d=document.getElementById('iD').value+"T12:00:00Z";
    const l=db.child('ArchIncoming').push().key;
    const updates={};
    // –î–û–ë–ê–í–ò–õ: type: 'GOODS', —á—Ç–æ–±—ã –æ—Ç–ª–∏—á–∞—Ç—å –æ—Ç —Å—ã—Ä—å—è
    updates['/ArchIncoming/'+l]={date:d,supplier:s,name:n,amount:a,num:num,ts:new Date().toISOString(), type: 'GOODS'};
    updates['/WeightStock/'+db.child('WeightStock').push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö–æ–¥ '+s + (num ? ' ‚Ññ'+num : ''),fLink:l,ts:new Date().toISOString()};
    await db.update(updates);
    closeModal();
}

async function sPack(){
    const sS = document.getElementById('s_pS'); const s = (sS.value==='NEW')?document.getElementById('i_pS').value:sS.value;
    const sN = document.getElementById('s_pN'); const n = (sN.value==='NEW')?document.getElementById('i_pN').value:sN.value;
    const a=parseFloat(document.getElementById('pA').value);
    if(!a)return;
    if(!confirm('–ü—Ä–∏–Ω—è—Ç—å?'))return;
    const d=document.getElementById('pD').value+"T12:00:00Z";
    const l=db.child('ArchPackIn').push().key;
    let cat='–ü–∞–∫–µ—Ç—ã'; if(n.includes('–°–∫–æ—Ç—á'))cat='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'; if(n.includes('–ü–ª–µ–Ω–∫–∞'))cat='–ü–ª–µ–Ω–∫–∞'; if(n.includes('–ú–µ—à–∫–∏'))cat='–ú–µ—à–∫–∏';
    const updates={};
    updates['/ArchPackIn/'+l]={date:d,supplier:s,name:n,amount:a,ts:new Date().toISOString()};
    updates[`/${cat}/`+db.child(cat).push().key]={name:n,amount:a,date:d,note:'–ü—Ä–∏—Ö–æ–¥ '+s,fLink:l,ts:new Date().toISOString()};
    await db.update(updates);
    closeModal();
}

async function sRawInc(){
    const sS = document.getElementById('s_rSupp'); const s = (sS.value==='NEW')?document.getElementById('i_rSupp').value:sS.value;
    const sN = document.getElementById('s_rN'); const n = (sN.value==='NEW')?document.getElementById('i_rN').value:sN.value;
    const a=parseFloat(document.getElementById('rA').value);
    if(!a)return;
    if(!confirm('–ü—Ä–∏–Ω—è—Ç—å —Å—ã—Ä—å–µ?'))return;
    const dInput = document.getElementById('rD').value; // –ë–ï–†–ï–ú –î–ê–¢–£ –ò–ó –ü–û–õ–Ø
    const dV = dInput + "T12:00:00Z";
    const ts = new Date().toISOString(); // –ê –≠–¢–û –î–õ–Ø –°–û–†–¢–ò–†–û–í–ö–ò
    const finalName = `${n} [${s}]`; 
    const l=db.child('ArchIncoming').push().key;
    const updates={};
    // –î–û–ë–ê–í–ò–õ: type: 'RAW', —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫ –Ω–µ –ª–µ–∑ –≤ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    updates['/ArchIncoming/'+l]={date:dV,supplier:s,name:n,amount:a,ts:ts, type: 'RAW'};
    updates['/Stock_Raw/'+db.child('Stock_Raw').push().key]={name:finalName,amount:a,date:dV,note:'–í—Ö '+s,fLink:l,ts:ts};
    await db.update(updates);
    closeModal();
}

async function delItemBatch(name, cat) {
    if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É "${name}" –∏ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?`)) return;
    const updates = {};
    if(data[cat]) {
        Object.entries(data[cat]).forEach(([key, val]) => {
            if(val.name === name) updates[`/${cat}/${key}`] = null;
        });
    }
    await db.update(updates);
    closeModal();
}

async function renameItem(oldN, cat) {
    const newN = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', oldN);
    if(!newN || newN === oldN) return;
    const updates = {};
    if(data[cat]) {
        Object.entries(data[cat]).forEach(([key, val]) => {
            if(val.name === oldN) updates[`/${cat}/${key}/name`] = newN;
        });
    }
    await db.update(updates);
    closeModal();
}

window.onload=renderHome;
</script></body></html>
