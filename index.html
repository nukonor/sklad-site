<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∫–ª–∞–¥ v118 - Audit Pro</title>
    
    <link rel="icon" type="image/png" href="https://i.ibb.co/Lz8ky3YJ/file-00000000ff1471f4b6d9f9d2c686ef67.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/Lz8ky3YJ/file-00000000ff1471f4b6d9f9d2c686ef67.png">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–°–∫–ª–∞–¥ v118">
    <meta name="theme-color" content="#5c67f2">

    <link rel="manifest" href="data:application/manifest+json,{'name':'–°–∫–ª–∞–¥ v118','short_name':'–°–∫–ª–∞–¥','start_url':'.','display':'standalone','background_color':'#f4f7f9','theme_color':'#5c67f2','icons':[{'src':'https://i.ibb.co/Lz8ky3YJ/file-00000000ff1471f4b6d9f9d2c686ef67.png','sizes':'512x512','type':'image/png'}]}">

    <style>
        :root { --bg: #f4f7f9; --card: #ffffff; --primary: #5c67f2; --success: #27ae60; --danger: #eb5757; --text: #2c3e50; --sub: #95a5a6; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; padding-bottom: 90px; }
        .menu { display: grid; grid-template-columns: repeat(5, 1fr) 45px; gap: 4px; margin-bottom: 15px; position: sticky; top: 0; background: var(--bg); padding: 5px 0; z-index: 100; }
        .btn-cat { border: none; border-radius: 10px; padding: 10px 2px; font-weight: 700; font-size: 10px; background: var(--card); color: var(--sub); }
        .btn-cat.active { background: var(--primary); color: white; }
        .card { background: var(--card); border-radius: 20px; padding: 15px; margin-bottom: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.03); }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f8f9fa; }
        .qty { font-size: 19px; font-weight: 900; }
        .qty-ok { color: var(--success); }
        .qty-alarm { color: #ff0000; animation: blink-danger 0.8s infinite; text-shadow: 0 0 5px rgba(235, 87, 87, 0.3); }
        @keyframes blink-danger { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .btn-hist-small { background: #f1f5f9; border: none; padding: 8px 12px; border-radius: 10px; font-size: 16px; margin-left: 10px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; padding: 15px; }
        .modal-box { background: white; width: 100%; max-width: 380px; border-radius: 24px; position: relative; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #eee; background: #fff; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding: 0 20px 20px 20px; text-align: left; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 1.5px solid #eee; border-radius: 14px; font-size: 16px; }
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; font-size: 16px; font-weight: 700; border-radius: 14px; margin-top: 10px; }
        .btn-close-x { background: #f1f5f9; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .admin-only { display: none !important; }
        body.auth-ok .admin-only { display: block !important; }
        .info-tag { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 5px; margin-right: 5px; text-transform: lowercase; }
        .tag-auto { background: #e0e7ff; color: #4338ca; }
        .tag-man { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .note-text { font-size: 11px; color: var(--primary); font-weight: 700; }
        .user-badge { font-size: 10px; color: var(--sub); text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body id="app">
    <div id="userStatus" class="user-badge">–í—Ö–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω</div>
    <div class="menu">
        <button class="btn-cat active" onclick="setCat('–ü–∞–∫–µ—Ç—ã', this)">–ü–∞–∫–µ—Ç—ã</button>
        <button class="btn-cat" onclick="setCat('–ü–ª–µ–Ω–∫–∞', this)">–ü–ª–µ–Ω–∫–∞</button>
        <button class="btn-cat" onclick="setCat('–°–∫–æ—Ç—á', this)">–°–∫–æ—Ç—á</button>
        <button class="btn-cat" onclick="setCat('–§–∞—Å–æ–≤–∫–∞', this)">–§–∞—Å–æ–≤–∫–∞</button>
        <button class="btn-cat" onclick="setCat('History', this)">–ñ—É—Ä–Ω–∞–ª</button>
        <button class="btn-cat" onclick="openModal('auth')" id="btnSettings">‚öôÔ∏è</button>
    </div>
    <div id="actions" class="admin-only"></div>
    <div id="content">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div id="modal" class="modal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modalTitle" style="margin:0"></h3>
                <button class="btn-close-x" onclick="closeModal()">‚úï</button>
            </div>
            <div id="modalBody" class="modal-body"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        const config = { apiKey: "AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q", databaseURL: "https://myproductionapp-bd872-default-rtdb.firebaseio.com", projectId: "myproductionapp-bd872" };
        firebase.initializeApp(config);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentCat = '–ü–∞–∫–µ—Ç—ã', isAdmin = false, currentUserEmail = 'guest', activeId = null, originalTime = null, cachedData = {};
        const products = ["–ê—Ä–Ω–∞—É—Ç–∫–∞", "–ê—Ä—Ç–µ–∫", "–Ø—á–∫–∞", "–ü—à–µ–Ω–∏—á–∫–∞", "–ö—É–∫—É—Ä—É–∑–∞", "–ì–æ—Ä–æ—Ö", "–ú–∞–Ω–∫–∞", "–•–ª–æ–ø—å—è", "–ì—Ä–µ—á–∫–∞", "–†–∏—Å –¥–ª", "–†–∏—Å –∫—Ä", "–†–∏—Å –ø—Ä", "–ü–µ—Ä–ª–æ–≤–∫–∞", "–ü—à–æ–Ω–æ", "–ö—É–∫.–º—É–∫–∞", "–ë–∞—Å–º–∞—Ç–∏ –≥", "–ë–∞—Å–º–∞—Ç–∏ –∫", "–ö—É—Ç—è", "–ö—É—Å –∫—É—Å", "–ù—É—Ç", "–ß–µ—á–µ–≤–∏—Ü–∞", "–ë—É–ª–≥—É—Ä"];
        const sizes = ["300√ó400", "370√ó500", "400√ó500", "420√ó550"];

        auth.onAuthStateChanged(user => {
            const statusDiv = document.getElementById('userStatus');
            if (user) {
                isAdmin = true;
                currentUserEmail = user.email;
                document.body.classList.add('auth-ok');
                statusDiv.innerText = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " + user.email;
            } else {
                isAdmin = false;
                currentUserEmail = 'guest';
                document.body.classList.remove('auth-ok');
                statusDiv.innerText = "–í—Ö–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω";
            }
            setCat(currentCat);
        });

        function formatSafeDate(dStr) {
            if(!dStr) return '--.--.----';
            const clean = dStr.split('T')[0].split('-');
            return clean.length < 3 ? dStr : `${clean[2]}.${clean[1]}.${clean[0]}`;
        }

        function getStatusClass(val, cat) {
            if (cat === '–ü–∞–∫–µ—Ç—ã' && val < 3000) return 'qty-alarm';
            if (cat === '–ü–ª–µ–Ω–∫–∞' && val < 60) return 'qty-alarm';
            if (cat === '–°–∫–æ—Ç—á' && val < 30) return 'qty-alarm';
            return 'qty-ok';
        }

        function setCat(cat, btn) {
            currentCat = cat;
            document.querySelectorAll('.btn-cat').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            renderActions(); loadData();
        }

        function renderActions() {
            const div = document.getElementById('actions');
            div.innerHTML = (currentCat === '–§–∞—Å–æ–≤–∫–∞') 
                ? `<button class="btn-main" onclick="openModal('fasovka')">+ –ù–æ–≤–∞—è —Å–º–µ–Ω–∞</button><div style="height:10px"></div>`
                : (currentCat !== 'History' ? `<button class="btn-main" onclick="openModal('add')">+ –ü—Ä–∏—Ö–æ–¥</button><div style="height:10px"></div>` : '');
        }

        function loadData() {
            db.ref('inventory').on('value', snap => {
                cachedData = snap.val() || {};
                if(currentCat === 'History') renderJournal(cachedData);
                else if(currentCat === '–§–∞—Å–æ–≤–∫–∞') renderFasList(cachedData.–§–∞—Å–æ–≤–∫–∞);
                else renderStock(cachedData, currentCat);
            });
        }

        function renderStock(all, cat) {
            const data = all[cat] || {}, totals = {};
            Object.values(data).forEach(v => { if(v.size) totals[v.size] = (totals[v.size] || 0) + (v.amount || 0); });
            let h = '<div class="card">';
            Object.keys(totals).sort().forEach(k => {
                const val = totals[k];
                h += `<div class="row"><b>${k}</b><div style="display:flex; align-items:center"><span class="qty ${getStatusClass(val, cat)}" onclick="isAdmin && openModal('edit', '${k}', ${val})">${val.toFixed(1)}</span><button class="btn-hist-small" onclick="showLocalHistory('${cat}', '${k}')">üìñ</button></div></div>`;
            });
            document.getElementById('content').innerHTML = h + '</div>';
        }

        function showLocalHistory(cat, size) {
            const data = cachedData[cat] || {};
            document.getElementById('modalTitle').innerText = size;
            let h = '';
            const sorted = Object.entries(data).map(([id, v]) => ({...v, id})).filter(v => v.size === size).sort((a,b) => b.date.localeCompare(a.date)).slice(0, 50);
            sorted.forEach(v => {
                const authorStr = v.author || '—Å–∏—Å—Ç–µ–º–∞';
                const tagClass = v.linkedId ? 'tag-auto' : 'tag-man';
                const tagName = v.linkedId ? '–∞–≤—Ç–æ' : authorStr.split('@')[0];
                h += `<div class="row" style="font-size:13px"><div><small style="color:var(--sub)">${formatSafeDate(v.date)}</small><br><span class="info-tag ${tagClass}">${tagName}</span> <span class="note-text">${v.note || ''}</span></div><div style="text-align:right"><b style="color:${v.amount>0?'var(--success)':'var(--danger)'}">${v.amount>0?'+':''}${v.amount.toFixed(1)}</b>${isAdmin ? `<br><span style="color:var(--danger);font-size:10px;font-weight:bold" onclick="deleteEntry('${cat}','${v.id}')">–£–î–ê–õ–ò–¢–¨</span>` : ''}</div></div>`;
            });
            document.getElementById('modalBody').innerHTML = h || '–ü—É—Å—Ç–æ';
            document.getElementById('modal').style.display = 'flex';
        }

        function renderFasList(data) {
            if(!data) { document.getElementById('content').innerHTML = '–ü—É—Å—Ç–æ'; return; }
            let h = '';
            Object.entries(data).sort((a,b) => b[1].date.localeCompare(a[1].date)).forEach(([id, v]) => {
                const rash = (parseFloat(v.vzial||0) - parseFloat(v.ostatok||0)).toFixed(1);
                h += `<div class="card" onclick="editFasovka('${id}')"><div style="display:flex;justify-content:space-between"><b>${v.name}</b> <small>${formatSafeDate(v.date)}</small></div><div style="margin:10px 0;font-size:16px"><b>${v.prihod||0}–∫–≥</b> ‚Üí <span style="color:var(--primary)">${v.vyhod||0}—à—Ç</span></div><div style="font-size:12px;color:var(--sub)">–ü–∞–∫–µ—Ç: ${v.size} | –ü–ª–µ–Ω–∫–∞: <b style="color:var(--danger)">${rash}–∫–≥</b> | <small>${(v.author||'').split('@')[0]}</small></div></div>`;
            });
            document.getElementById('content').innerHTML = h;
        }

        function renderJournal(all) {
            let h = '<div class="card">';
            let list = [];
            ['–ü–∞–∫–µ—Ç—ã', '–ü–ª–µ–Ω–∫–∞', '–°–∫–æ—Ç—á'].forEach(cat => { if(all[cat]) Object.entries(all[cat]).forEach(([id, v]) => list.push({...v, cat, id})); });
            list.sort((a,b) => b.date.localeCompare(a.date)).slice(0, 50).forEach(v => {
                const tagClass = v.linkedId ? 'tag-auto' : 'tag-man';
                const authorShort = (v.author || '—Å–∏—Å—Ç–µ–º–∞').split('@')[0];
                h += `<div class="row" style="font-size:13px"><div><small>${formatSafeDate(v.date)} | ${v.cat}</small><br><b>${v.size}</b><br><span class="info-tag ${tagClass}">${v.linkedId?'–∞–≤—Ç–æ':authorShort}</span> <span class="note-text">${v.note||''}</span></div><b style="color:${v.amount>0?'var(--success)':'var(--danger)'}">${v.amount>0?'+':''}${v.amount.toFixed(1)}</b></div>`;
            });
            document.getElementById('content').innerHTML = h + '</div>';
        }

        function openModal(type, name, val) {
            const title = document.getElementById('modalTitle'), body = document.getElementById('modalBody');
            if(type === 'auth') { 
                title.innerText = '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É'; 
                body.innerHTML = `
                    <input type="email" id="loginEmail" placeholder="Email" value="nukonor@gmail.com">
                    <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="btn-main" onclick="login()">–í–æ–π—Ç–∏</button>
                    ${isAdmin ? '<button class="btn-main" style="background:var(--danger)" onclick="logout()">–í–´–ô–¢–ò</button>' : ''}`; 
            }
            else if(type === 'edit') { title.innerText = name; body.innerHTML = `<p>–ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫:</p><input type="number" id="newQty" value="${val.toFixed(1)}"><button class="btn-main" onclick="saveEdit('${name}', ${val})">–û–±–Ω–æ–≤–∏—Ç—å</button>`; }
            else if(type === 'add') { 
                title.innerText = '–ü—Ä–∏—Ö–æ–¥: ' + currentCat; 
                body.innerHTML = `
                    <label style="font-size:12px;color:var(--sub)">–î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞:</label>
                    <input type="date" id="addDate" value="${new Date().toISOString().split('T')[0]}">
                    <select id="selSize">${(currentCat==='–ü–ª–µ–Ω–∫–∞'?products:(currentCat==='–ü–∞–∫–µ—Ç—ã'?sizes:['–°–∫–æ—Ç—á 360–≥'])).map(s=>`<option>${s}</option>`).join('')}</select>
                    <input type="number" id="amt" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                    <button class="btn-main" onclick="saveAdd()">–î–æ–±–∞–≤–∏—Ç—å</button>`; 
            }
            else if(type === 'fasovka') { title.innerText = '–§–∞—Å–æ–≤–∫–∞'; body.innerHTML = `<input type="date" id="fDate" value="${new Date().toISOString().split('T')[0]}"><select id="fName">${products.map(p=>`<option>${p}</option>`).join('')}</select><select id="fSize">${sizes.map(s=>`<option>${s}</option>`).join('')}</select><input type="number" id="fPrihod" placeholder="–°—ã—Ä—å–µ –∫–≥"><input type="number" id="fVyhod" placeholder="–í—ã—Ö–æ–¥ —à—Ç"><input type="number" id="fVzial" placeholder="–í–∑—è–ª –ø–ª–µ–Ω–∫–∏ –∫–≥"><input type="number" id="fOstatok" placeholder="–û—Å—Ç–∞—Ç–æ–∫ –∫–≥"><button class="btn-main" id="btnFasSave" onclick="saveFasovka()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn-main" id="btnFasDel" style="background:var(--danger);display:none" onclick="deleteFasovka()">–£–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç</button>`; }
            document.getElementById('modal').style.display = 'flex';
        }

        async function saveFasovka() {
            const d = document.getElementById('fDate').value, time = activeId ? originalTime : new Date().toISOString().split('T')[1], fullDate = d + "T" + time;
            const name = document.getElementById('fName').value, size = document.getElementById('fSize').value, vyhod = parseFloat(document.getElementById('fVyhod').value)||0, vzial = parseFloat(document.getElementById('fVzial').value)||0, ostatok = parseFloat(document.getElementById('fOstatok').value)||0, prihod = document.getElementById('fPrihod').value;
            const btn = document.getElementById('btnFasSave'); btn.disabled = true; btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
            try {
                if(activeId) { for(let c of ['–ü–∞–∫–µ—Ç—ã', '–ü–ª–µ–Ω–∫–∞', '–°–∫–æ—Ç—á']) { const snap = await db.ref('inventory/'+c).once('value'); snap.forEach(ch => { if(ch.val().linkedId === activeId) ch.ref.remove(); }); } }
                const ref = activeId ? db.ref('inventory/–§–∞—Å–æ–≤–∫–∞/'+activeId) : db.ref('inventory/–§–∞—Å–æ–≤–∫–∞').push(), nId = activeId || ref.key;
                await ref.set({ date: fullDate, name, size, vyhod, vzial, ostatok, prihod: prihod, author: currentUserEmail });
                if(vyhod > 0) {
                    await db.ref('inventory/–ü–∞–∫–µ—Ç—ã').push({ size, amount: -(vyhod*0.103), date: fullDate, linkedId: nId, note: '–°–ø–∏—Å–∞–Ω–∏–µ: '+name, author: currentUserEmail });
                    await db.ref('inventory/–°–∫–æ—Ç—á').push({ size: '–°–∫–æ—Ç—á 360–≥', amount: -((vyhod*0.12)/360), date: fullDate, linkedId: nId, note: '–°–ø–∏—Å–∞–Ω–∏–µ: '+name, author: currentUserEmail });
                }
                if(vzial-ostatok !== 0) { await db.ref('inventory/–ü–ª–µ–Ω–∫–∞').push({ size: name, amount: -(vzial-ostatok), date: fullDate, linkedId: nId, note: '–†–∞—Å—Ö–æ–¥ —Ñ–∞—Å–æ–≤–∫–∞', author: currentUserEmail }); }
                closeModal();
            } catch (err) { alert("–û—à–∏–±–∫–∞: " + err.message); } finally { btn.disabled = false; btn.innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"; }
        }

        async function saveEdit(name, old) { 
            const nv = parseFloat(document.getElementById('newQty').value); 
            await db.ref(`inventory/${currentCat}`).push({ 
                size: name, 
                amount: nv - old, 
                date: new Date().toISOString(), 
                note: '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è', 
                author: currentUserEmail 
            }); 
            closeModal(); 
        }
        
        async function saveAdd() { 
            const s = document.getElementById('selSize').value, a = parseFloat(document.getElementById('amt').value), d = document.getElementById('addDate').value;
            if(a) {
                await db.ref(`inventory/${currentCat}`).push({ size: s, amount: a, date: d + "T12:00:00Z", note: '–ü—Ä–∏—Ö–æ–¥', author: currentUserEmail }); 
                closeModal(); 
            }
        }

        async function deleteFasovka() { if(confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç?')) { for(let c of ['–ü–∞–∫–µ—Ç—ã', '–ü–ª–µ–Ω–∫–∞', '–°–∫–æ—Ç—á']) { const s = await db.ref('inventory/'+c).once('value'); s.forEach(ch => { if(ch.val().linkedId === activeId) ch.ref.remove(); }); } await db.ref('inventory/–§–∞—Å–æ–≤–∫–∞/'+activeId).remove(); closeModal(); } }
        async function deleteEntry(cat, id) { if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) { await db.ref(`inventory/${cat}/${id}`).remove(); closeModal(); } }
        
        async function login() { 
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('pass').value;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                closeModal(); 
            } catch (e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
        }
        function logout() { auth.signOut(); closeModal(); }
        function closeModal() { document.getElementById('modal').style.display = 'none'; activeId = null; }
        window.onload = () => setCat('–ü–∞–∫–µ—Ç—ã');
    </script>
</body>
</html>
