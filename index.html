<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>–°–∫–ª–∞–¥ v309</title><style>
:root{--bg:#f4f7f9;--p:#4e73df;--d:#e74a3b;--s:#1cc88a;--b:#bbb}body{font-family:sans-serif;background:var(--bg);margin:0;padding:5px;padding-bottom:80px}.dash-grid{display:flex;flex-direction:column;gap:5px;max-width:500px;margin:0 auto}.dash-item{background:#fff;border-radius:8px;padding:18px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid var(--b);font-weight:700;color:var(--p);text-transform:uppercase;font-size:13px}.card{background:#fff;border-radius:10px;padding:12px;margin-bottom:8px;border:1.5px solid var(--b);position:relative}.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;padding:5px}.modal-box{background:#fff;width:100%;max-width:380px;border-radius:12px;max-height:92vh;display:flex;flex-direction:column}.modal-body{overflow-y:auto;padding:15px}input,select{width:100%;padding:10px;margin:4px 0;border:1px solid var(--b);border-radius:6px;font-size:16px;box-sizing:border-box;color:#000;font-weight:600}.btn-main{background:var(--p);color:#fff;border:none;width:100%;padding:14px;font-size:13px;font-weight:700;border-radius:8px;margin:2px 0;text-transform:uppercase}.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;grid-template-columns:1fr 1fr;gap:5px;padding:8px;border-top:1px solid var(--b);z-index:900}body.nav-active .bottom-nav{display:grid}.tab-h{display:flex;gap:2px;margin-bottom:8px}.tab-b{flex:1;padding:10px 5px;font-size:10px;font-weight:900;background:#ddd;border:1px solid var(--b);border-radius:6px;color:#555;text-transform:uppercase}.tab-b.active{background:var(--p)!important;color:#fff!important;border-color:#000}.report-line{display:flex;justify-content:space-between;padding:3px 0;font-size:12px;border-bottom:1px solid #f2f2f2}.item-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px}.item-card{background:#fff;border:1.5px solid #000;border-radius:6px;padding:5px 2px;text-align:center;position:relative;cursor:pointer}.item-card.selected{border-color:var(--s);background:rgba(28,200,138,0.1)}.item-title{font-size:10px;font-weight:900;text-transform:uppercase;height:32px;display:flex;align-items:center;justify-content:center}.item-qty{font-size:13px;font-weight:900;color:var(--p)}.sel-q{position:absolute;top:-2px;right:-2px;background:var(--s);color:#fff;font-size:10px;padding:1px 4px;border-radius:4px;font-weight:700}.folder{background:#eee;padding:10px;border-radius:6px;margin-bottom:3px;font-weight:700;cursor:pointer;display:flex;justify-content:space-between;color:var(--p);font-size:13px}.f-content{display:none;padding-left:8px;border-left:2px solid var(--p);margin-left:4px}
</style></head><body><div id="uS" style="font-size:10px;text-align:center;margin-bottom:5px">–ó–ê–ì–†–£–ó–ö–ê...</div><div id="act"></div><div id="cnt"></div><div class="bottom-nav"><button class="btn-main" onclick="renderHome()" style="background:#555">–ú–ï–ù–Æ</button><button class="btn-main" onclick="goBack()" style="background:#888">–ù–ê–ó–ê–î</button></div><div id="mdl" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid #eee"><h4 id="mT" style="margin:0"></h4><button onclick="closeModal()" style="border:none;background:none;font-size:20px">‚úï</button></div><div id="mB" class="modal-body"></div></div></div>
<div id="qMdl" class="modal" style="z-index:2000"><div class="modal-box" style="max-width:250px;margin-top:-100px"><div class="modal-body"><h4 id="qTi" style="margin:0 0 10px 0;font-size:13px"></h4><input type="number" id="qIn" inputmode="decimal" placeholder="0.00"><button class="btn-main" onclick="confirmQ()">OK</button></div></div></div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
const cfg={apiKey:"AIzaSyAya0CSXtG3Fh4GzJ2bV7AJ0BaYEcTXK9Q",databaseURL:"https://myproductionapp-bd872-default-rtdb.firebaseio.com",projectId:"myproductionapp-bd872"};
if(!firebase.apps.length)firebase.initializeApp(cfg);const db=firebase.database().ref('production'),auth=firebase.auth();let cur='Home',data={},sItems={},curSel={c:'',p:''},archSub='',corrMode=false;
const bP=["–ê—Ä–Ω–∞—É—Ç–∫–∞","–ê—Ä—Ç–µ–∫","–ë–∞—Å–º–∞—Ç–∏ –≥","–ë–∞—Å–º–∞—Ç–∏ –∫","–ë—É–ª–≥—É—Ä","–ì–æ—Ä–æ—Ö","–ì—Ä–µ—á–∫–∞","–ö—É–∫—É—Ä—É–∑–∞","–ö—É–∫.–º—É–∫–∞","–ö—É—Å –∫—É—Å","–ö—É—Ç—è","–ú–∞–Ω–∫–∞","–ù—É—Ç","–ü–µ—Ä–ª–æ–≤–∫–∞","–ü—à–µ–Ω–∏—á–∫–∞","–ü—à–æ–Ω–æ","–†–∏—Å –¥–ª","–†–∏—Å –∫—Ä","–†–∏—Å –ø—Ä","–•–ª–æ–ø—å—è","–ß–µ—á–µ–≤–∏—Ü–∞","–Ø—á–∫–∞"],szs=["300√ó400","370√ó500","400√ó500","420√ó550"],mths=["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
const fd=i=>i?i.split('T')[0].split('-').reverse().join('.'):'';const closeModal=()=>document.getElementById('mdl').style.display='none';const toggleF=id=>{const e=document.getElementById(id);e.style.display=e.style.display==='block'?'none':'block'};
const gP=(cat)=>{const s=new Set();if(cat==='–ì–æ—Ç–æ–≤–∞—è'||cat==='WeightStock')bP.forEach(x=>s.add(x));if(data[cat])Object.values(data[cat]).forEach(v=>s.add(v.name));return Array.from(s).filter(x=>x).sort();};
const gExt=(cat)=>{const s=new Set();if(data[cat])Object.values(data[cat]).forEach(v=>s.add(v.name));return Array.from(s).sort();};
function renderHome(){cur='Home';document.body.classList.remove('nav-active');document.getElementById('cnt').innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('StockRoot')">–°–∫–ª–∞–¥</div><div class="dash-item" onclick="setCat('ProdSub')">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</div><div class="dash-item" onclick="setCat('PackSub')">–£–ø–∞–∫–æ–≤–∫–∞</div><div class="dash-item" onclick="openModal('auth')" style="color:#aaa">–í—Ö–æ–¥</div></div>`;document.getElementById('act').innerHTML='';}
function goBack(){const m={'GP_Root':'StockRoot','StockList':'GP_Root','WeightStock':'GP_Root','WeightDV':'GP_Root','Korma':'GP_Root','Invoices':'StockRoot','ArchSubIn':'Invoices','ArchSubOut':'Invoices','–§–∞—Å–æ–≤–∫–∞':'ProdSub','–ö—Ä—É–ø–æ—Ä—É—à–∫–∞':'ProdSub','–ü–ª–µ–Ω–∫–∞':'PackSub','–ü–∞–∫–µ—Ç—ã':'PackSub','–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º':'PackSub','InvoicesDate':'ArchSub','InvoicesClient':'ArchSub'};let n=m[cur]||'Home';if(cur==='InvoicesDate'||cur==='InvoicesClient')n=archSub==='In'?'ArchSubIn':'ArchSubOut';setCat(n);}
function setCat(c){cur=c;document.body.classList.add('nav-active');const a=document.getElementById('act'),ct=document.getElementById('cnt');a.innerHTML='';if(c==='Home'){renderHome();return}if(c==='StockRoot')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('GP_Root')">–ì–æ—Ç–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è</div><div class="dash-item" onclick="setCat('Invoices')">–ê—Ä—Ö–∏–≤ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px"><button class="btn-main" style="background:var(--s)" onclick="openModal('inc')">–ü—Ä–∏—Ö–æ–¥</button><button class="btn-main" style="background:var(--d)" onclick="openModal('ship')">–û—Ç–≥—Ä—É–∑–∫–∞</button></div></div>`;else if(c==='GP_Root')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('StockList')">–§–∞—Å–æ–≤–∫–∞</div><div class="dash-item" onclick="setCat('WeightStock')">–í–µ—Å (–ó–∞–∫—É–ø–∫–∞)</div><div class="dash-item" onclick="setCat('WeightDV')">–í–µ—Å (–î–í)</div><div class="dash-item" onclick="setCat('Korma')">–ö–æ—Ä–º–∞</div><button class="btn-main" style="background:#7f8c8d;margin-top:10px" onclick="corrMode=!corrMode;loadData()">${corrMode?'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–ö–õ':'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–´–ö–õ'}</button></div>`;else if(c==='ProdSub')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–§–∞—Å–æ–≤–∫–∞')">–¶–µ—Ö —Ñ–∞—Å–æ–≤–∫–∏</div><div class="dash-item" onclick="setCat('–ö—Ä—É–ø–æ—Ä—É—à–∫–∞')">–ö—Ä—É–ø–æ—Ä—É—à–∫–∞</div></div>`;else if(c==='PackSub'){a.innerHTML=`<button class="btn-main" style="background:#7f8c8d" onclick="corrMode=!corrMode;loadData()">${corrMode?'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–ö–õ':'–ö–û–†–†–ï–ö–¶–ò–Ø: –í–´–ö–õ'}</button>`;ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('–ü–ª–µ–Ω–∫–∞')">–ü–ª–µ–Ω–∫–∞</div><div class="dash-item" onclick="setCat('–ü–∞–∫–µ—Ç—ã')">–ü–∞–∫–µ—Ç—ã</div><div class="dash-item" onclick="setCat('–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º')">–°–∫–æ—Ç—á</div></div>`;}else if(c==='Invoices')ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('ArchSubIn')">–ü—Ä–∏—Ö–æ–¥—ã</div><div class="dash-item" onclick="setCat('ArchSubOut')">–û—Ç–≥—Ä—É–∑–∫–∏</div></div>`;else if(c==='ArchSubIn'||c==='ArchSubOut'){archSub=c==='ArchSubIn'?'In':'Out';ct.innerHTML=`<div class="dash-grid"><div class="dash-item" onclick="setCat('InvoicesDate')">–ü–æ –¥–∞—Ç–∞–º</div><div class="dash-item" onclick="setCat('InvoicesClient')">–ü–æ –∏–º–µ–Ω–∞–º</div></div>`;}if(c==='–§–∞—Å–æ–≤–∫–∞')a.innerHTML=`<button class="btn-main" onclick="openModal('fas')">+ –ó–∞–ø–∏—Å—å —Ñ–∞—Å–æ–≤–∫–∏</button>`;if(c==='–ö—Ä—É–ø–æ—Ä—É—à–∫–∞')a.innerHTML=`<button class="btn-main" style="background:var(--s)" onclick="openModal('krup')">+ –°–º–µ–Ω–∞ –ö—Ä—É–ø–æ—Ä—É—à–∫–∏</button>`;loadData();}
function loadData(){db.on('value',s=>{data=s.val()||{};const c=document.getElementById('cnt');if(!c||['Home','StockRoot','GP_Root','ProdSub','Invoices','ArchSubIn','ArchSubOut','PackSub'].includes(cur))return;if(cur==='–§–∞—Å–æ–≤–∫–∞')rFas(c);else if(cur==='–ö—Ä—É–ø–æ—Ä—É—à–∫–∞')rKrup(c);else if(cur==='WeightDV')rStore(c,'WeightDV','–∫–≥');else if(cur==='StockList')rStore(c,'–ì–æ—Ç–æ–≤–∞—è','—à—Ç');else if(cur==='WeightStock')rStore(c,'WeightStock','–∫–≥');else if(cur==='Korma')rStore(c,'Korma','–∫–≥');else if(cur==='InvoicesDate')rInvD(c);else if(cur==='InvoicesClient')rInvC(c);else rGen(c);});}
</script>
<script>
function setTab(idx){document.querySelectorAll('.tab-b').forEach((b,i)=>b.classList.toggle('active',i===idx));document.querySelectorAll('.tab-c').forEach((c,i)=>c.style.display=i===idx?'block':'none');}
function openModal(t,id){const ti=document.getElementById('mT'),b=document.getElementById('mB');if(t==='ship'){sItems={};ti.innerText='–û—Ç–≥—Ä—É–∑–∫–∞';let h=`–î–∞—Ç–∞:<input type="date" id="sD" value="${new Date().toISOString().split('T')[0]}">–ö–ª–∏–µ–Ω—Ç:<input type="text" id="sCN" list="clL" placeholder="–ö–ª–∏–µ–Ω—Ç"><datalist id="clL">${[...new Set(Object.values(data.ArchInvoices||{}).map(v=>v.client))].map(c=>`<option value="${c}">`).join('')}</datalist>‚Ññ –ù–∞–∫–ª:<input type="text" id="sNum"><div class="tab-h"><button class="tab-b active" onclick="setTab(0)">–§–ê–°</button><button class="tab-b" onclick="setTab(1)">–í–ï–°</button><button class="tab-b" onclick="setTab(2)">–î–í</button><button class="tab-b" onclick="setTab(3)">–ö–û–†–ú</button></div><div id="t0" class="tab-c">${rShipGrid('–ì–æ—Ç–æ–≤–∞—è')}</div><div id="t1" class="tab-c" style="display:none">${rShipGrid('WeightStock')}</div><div id="t2" class="tab-c" style="display:none">${rShipGrid('WeightDV')}</div><div id="t3" class="tab-c" style="display:none">${rShipGrid('Korma')}</div>`;b.innerHTML=h+`<button class="btn-main" style="background:var(--s);margin-top:10px" onclick="sShip()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>`;}else if(t==='krup'){ti.innerText='–ö—Ä—É–ø–æ—Ä—É—à–∫–∞';let h=`–î–∞—Ç–∞:<input type="date" id="kD" value="${new Date().toISOString().split('T')[0]}">–ö—Ä—É–ø–∞:<input type="text" id="kRN" list="kRL" placeholder="–ö—Ä—É–ø–∞"><datalist id="kRL">${gExt('KrupNames').map(n=>`<option value="${n}">`).join('')}</datalist>`;['–ö—Ä—É–ø–∞ 1','–ö—Ä—É–ø–∞ 2','–ö—Ä—É–ø–∞ 3','–ú—É—á–∫–∞','–û—Ç—Ä—É–±–∏'].forEach((n,idx)=>{h+=`<div style="font-size:11px;font-weight:700;margin-top:5px" id="kn${idx}">${n}</div><div class="krup-row"><input type="number" id="km${idx}" placeholder="–ú–µ—à–∫–æ–≤"><input type="number" id="kw${idx}" placeholder="–í–µ—Å –º–µ—à–∫–∞"></div>`});b.innerHTML=h+`<button class="btn-main" onclick="sKrup()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;}else if(t==='fas'){ti.innerText='–§–∞—Å–æ–≤–∫–∞';b.innerHTML=`–î–∞—Ç–∞:<input type="date" id="fD" value="${new Date().toISOString().split('T')[0]}">–ö—Ä—É–ø–∞:<select id="fN">${bP.map(p=>`<option>${p}</option>`).join('')}</select>–°–ø–∏—Å–∞—Ç—å:<select id="fRaw">${gP('WeightStock').map(p=>`<option>${p}</option>`).join('')}</select><input type="number" id="fV" placeholder="–í—ã—Ö–æ–¥ —à—Ç"><input type="text" id="fVz" placeholder="–ü–ª–µ–Ω–∫–∞ –≤–∑—è—Ç–æ"><input type="number" id="fOs" placeholder="–ü–ª–µ–Ω–∫–∞ –æ—Å—Ç–∞—Ç–æ–∫"><button class="btn-main" onclick="sFas()">–°–û–•–†–ê–ù–ò–¢–¨</button>`;}else if(t==='auth'){ti.innerText='–í—Ö–æ–¥';b.innerHTML=`<input type="email" id="lE" value="nukonor@gmail.com"><input type="password" id="lP"><button class="btn-main" onclick="auth.signInWithEmailAndPassword(document.getElementById('lE').value,document.getElementById('lP').value).then(closeModal)">–í–•–û–î</button>`;}else if(t==='vInv'){const [rid,key]=id.split('|'),v=data[key][rid];ti.innerText='–ù–∞–∫–ª–∞–¥–Ω–∞—è';b.innerHTML=`<b>${v.client||v.supplier}</b> (${fd(v.date)})<br>‚Ññ ${v.num||'–ë/–ù'}<hr><div style="font-size:12px">${v.items?v.items.join('<br>'):(v.name+': '+v.amount)}</div><button class="btn-main" style="background:var(--d);margin-top:15px" onclick="delArchRec('${key}','${rid}')">–£–î–ê–õ–ò–¢–¨</button>`;}document.getElementById('mdl').style.display='flex';}
function rFas(c){let h='';if(data.–§–∞—Å–æ–≤–∫–∞){Object.entries(data.–§–∞—Å–æ–≤–∫–∞).sort((a,b)=>b[1].ts.localeCompare(a[1].ts)).forEach(([id,v])=>{const k=(v.name==="–ö—É—Ç—è")?19.8:9.9,pk=Math.round(v.vyhod/k),sk=((v.vyhod*0.12)/360).toFixed(1),pl=Math.abs((v.vzial||0)-(v.ostatok||0)).toFixed(1);h+=`<div class="card"><b>${v.name.toUpperCase()}</b> [${fd(v.date)}]<div class="report-line"><span>–°—ã—Ä—å–µ:</span><b>${v.prihod}–∫–≥ [${v.rawItem}]</b></div><div class="report-line"><span>–í—ã—Ö–æ–¥:</span><b>${v.vyhod}—à—Ç</b></div><div class="report-line"><span>–ü–∞–∫–µ—Ç—ã:</span><b>${pk}—à—Ç</b></div><div class="report-line"><span>–ü–ª–µ–Ω–∫–∞:</span><b>${pl}–∫–≥</b></div><div class="report-line"><span>–°–∫–æ—Ç—á:</span><b>${sk}—Ä—É–ª</b></div><button class="btn-main" style="background:var(--d);padding:6px;font-size:10px;margin-top:8px" onclick="delFas('${id}')">–£–î–ê–õ–ò–¢–¨</button></div>`;});}c.innerHTML=h||'–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç';}
function rKrup(c){let h='';if(data.–ö—Ä—É–ø–æ—Ä—É—à–∫–∞){Object.entries(data.–ö—Ä—É–ø–æ—Ä—É—à–∫–∞).sort((a,b)=>b[1].ts.localeCompare(a[1].ts)).forEach(([id,v])=>{h+=`<div class="card"><b>${v.rawName.toUpperCase()} [${fd(v.date)}]</b><div style="margin-top:5px;font-size:11px">`;v.items.forEach(i=>h+=`<div class="report-line"><span>${i.n}:</span><b>${i.kg}–∫–≥ (${i.m}–º–µ—à –ø–æ ${i.w}–∫–≥)</b></div>`);h+=`</div><button class="btn-main" style="background:var(--d);padding:6px;font-size:10px;margin-top:8px" onclick="delKrup('${id}')">–£–î–ê–õ–ò–¢–¨</button></div>`;});}c.innerHTML=h||'–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç';}
function rStore(c,dbK,u){const t={};if(dbK==='–ì–æ—Ç–æ–≤–∞—è'||dbK==='WeightStock')gP(dbK).forEach(p=>t[p]=0);if(data[dbK])Object.values(data[dbK]).forEach(v=>t[v.name]=(t[v.name]||0)+v.amount);let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(n=>{if(t[n]===0 && !bP.includes(n)) return;h+=`<div class="item-card"><div class="item-title">${n}</div><div class="item-qty">${Math.round(t[n])} <small>${u}</small></div><div style="display:flex;justify-content:center;gap:4px"><button style="border:none;background:#f0f0f0;font-size:10px;padding:4px;width:45%" onclick="showH('${dbK}','${n}')">üìú</button><button class="corr-btn" onclick="openModal('corr','${dbK}|${n}')">¬±</button></div></div>`;});c.innerHTML=h+'</div>';}
function rShipGrid(cat){const list=gExt(cat);return `<div class="item-grid">${list.map(p=>`<div class="item-card" id="scard-${cat}-${p.replace(/\s|\(|\)/g,'')}" onclick="openQ('${cat}','${p}')"><div class="item-title">${p}</div><div id="sq-${cat}-${p.replace(/\s|\(|\)/g,'')}" class="sel-q" style="display:none">0</div></div>`).join('')}</div>`;}
function openQ(cat,p){curSel={c:cat,p:p};document.getElementById('qTi').innerText=p;document.getElementById('qIn').value='';document.getElementById('qMdl').style.display='flex';setTimeout(()=>document.getElementById('qIn').focus(),100);}
function confirmQ(){const q=parseFloat(document.getElementById('qIn').value),{c,p}=curSel,id=`${c}-${p.replace(/\s|\(|\)/g,'')}`;if(q>0){sItems[`${c}|${p}`]=q;document.getElementById('sq-'+id).innerText=q;document.getElementById('sq-'+id).style.display='block';document.getElementById('scard-'+id).classList.add('selected');}else{delete sItems[`${c}|${p}`];document.getElementById('sq-'+id).style.display='none';document.getElementById('scard-'+id).classList.remove('selected');}document.getElementById('qMdl').style.display='none';}
async function sShip(){const d=document.getElementById('sD').value,cl=document.getElementById('sCN').value,num=document.getElementById('sNum').value,upd={},ts=new Date().toISOString(),itms=[];Object.entries(sItems).forEach(([key,a])=>{const [c,p]=key.split('|');itms.push(`${p}: ${a}`);upd[`/${c}/${db.child(c).push().key}`]={name:p,amount:-a,date:d+"T12:00:00Z",ts:ts,client:cl,note:num};});if(itms.length){upd['/ArchInvoices/'+db.child('ArchInvoices').push().key]={date:d+"T12:00:00Z",ts:ts,client:cl,items:itms,num:num};await db.update(upd);closeModal();}}
async function sKrup(){const d=document.getElementById('kD').value,raw=document.getElementById('kRN').value,ts=new Date().toISOString(),upd={},items=[],kId=db.child('–ö—Ä—É–ø–æ—Ä—É—à–∫–∞').push().key;if(!raw)return;upd['/KrupNames/'+db.child('KrupNames').push().key]={name:raw};for(let i=0;i<5;i++){const n=document.getElementById('kn'+i).innerText,m=parseFloat(document.getElementById('km'+i).value)||0,w=parseFloat(document.getElementById('kw'+i).value)||0;if(m>0&&w>0){const tot=m*w;let isK=(n==='–ú—É—á–∫–∞'||n==='–û—Ç—Ä—É–±–∏');let fn=isK?`${raw} ${n}`:`${raw} (${w}–∫–≥) ${n}`;let path=isK?'/Korma/':'/WeightDV/';items.push({n:n,m:m,w:w,kg:tot});upd[path+db.child('Korma').push().key]={name:fn,amount:tot,date:d+"T12:00:00Z",ts:ts,note:'–ö—Ä—É–ø–æ—Ä—É—à–∫–∞',kLink:kId};}}if(items.length){upd['/–ö—Ä—É–ø–æ—Ä—É—à–∫–∞/'+kId]={date:d+"T12:00:00Z",ts:ts,rawName:raw,items:items};await db.update(upd);closeModal();}}
async function sFas(){const d=document.getElementById('fD').value,n=document.getElementById('fN').value,raw=document.getElementById('fRaw').value,v=parseFloat(document.getElementById('fV').value),p=parseFloat(document.getElementById('fP').value),os=parseFloat(document.getElementById('fOs').value);let vzT=0;try{vzT=eval(document.getElementById('fVz').value.replace(/,/g,'.').replace(/[^-+0-9.]/g,''))||0}catch(e){}const fId=db.child('–§–∞—Å–æ–≤–∫–∞').push().key,ts=new Date().toISOString(),upd={};upd['/–§–∞—Å–æ–≤–∫–∞/'+fId]={date:d+"T12:00:00Z",name:n,rawItem:raw,vyhod:v,prihod:p,vzial:vzT,ostatok:os,ts:ts};upd['/–ì–æ—Ç–æ–≤–∞—è/'+db.child('–ì–æ—Ç–æ–≤–∞—è').push().key]={name:n,amount:v,date:d+"T12:00:00Z",note:'–§–∞—Å–æ–≤–∫–∞',fLink:fId,ts:ts};upd['/WeightStock/'+db.child('WeightStock').push().key]={name:raw,amount:-p,date:d+"T12:00:00Z",note:'–§–∞—Å–æ–≤–∫–∞: '+n,fLink:fId,ts:ts};await db.update(upd);closeModal();}
async function delFas(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?')){const upd={};upd['/–§–∞—Å–æ–≤–∫–∞/'+id]=null;['–ì–æ—Ç–æ–≤–∞—è','WeightStock'].forEach(cat=>{if(data[cat])Object.entries(data[cat]).forEach(([rid,v])=>{if(v.fLink===id)upd['/'+cat+'/'+rid]=null;});});await db.update(upd);}}
async function delKrup(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?')){const upd={};upd['/–ö—Ä—É–ø–æ—Ä—É—à–∫–∞/'+id]=null;if(data.WeightDV)Object.entries(data.WeightDV).forEach(([rid,v])=>{if(v.kLink===id)upd['/WeightDV/'+rid]=null;});if(data.Korma)Object.entries(data.Korma).forEach(([rid,v])=>{if(v.kLink===id)upd['/Korma/'+rid]=null;});await db.update(upd);}}
async function delArchRec(cat,id){if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;const v=data[cat][id],upd={},ts=v.ts;upd['/'+cat+'/'+id]=null;if(cat==='ArchInvoices'){['–ì–æ—Ç–æ–≤–∞—è','WeightStock','WeightDV','Korma'].forEach(s=>{if(data[s])Object.entries(data[s]).forEach(([rid,sv])=>{if(sv.ts===ts)upd['/'+s+'/'+rid]=null;});});}else{['WeightStock','–ì–æ—Ç–æ–≤–∞—è'].forEach(s=>{if(data[s])Object.entries(data[s]).forEach(([rid,sv])=>{if(sv.ts===ts)upd['/'+s+'/'+rid]=null;});});}await db.update(upd);closeModal();}
function showH(c,k){const ti=document.getElementById('mT'),b=document.getElementById('mB');ti.innerText=k;const hst=[];if(data[c])Object.entries(data[c]).filter(([id,v])=>v.name===k).forEach(([id,v])=>hst.push({d:v.date,n:v.note||'–ó–∞–ø–∏—Å—å',a:v.amount,id:id,ts:v.ts||v.date}));let res='<table style="width:100%;font-size:11px;border-collapse:collapse">';hst.sort((a,b)=>b.ts.localeCompare(a.ts)).forEach(v=>{res+=`<tr style="border-bottom:1px solid #ccc"><td style="padding:6px 0">${fd(v.d)}<br>${v.n}</td><td style="text-align:right">${v.a}</td><td style="width:30px;text-align:right"><button onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å?')){db.child('${c}').child('${v.id}').remove();closeModal()}" style="border:none;background:none;color:red">‚úï</button></td></tr>`});b.innerHTML=res+'</table>';document.getElementById('mdl').style.display='flex'}
function rInvD(c){const dbK=(archSub==='In'?'ArchIncoming':'ArchInvoices'),d=data[dbK]||{},t={};Object.entries(d).forEach(([id,v])=>{const dt=new Date(v.date),y=dt.getFullYear(),m=dt.getMonth(),dy=dt.getDate();if(!t[y])t[y]={c:0,m:{}};if(!t[y].m[m])t[y].m[m]={c:0,d:{}};if(!t[y].m[m].d[dy])t[y].m[m].d[dy]=[];t[y].m[m].d[dy].push({...v,id});t[y].c++;t[y].m[m].c++;});let h='';Object.keys(t).sort((a,b)=>b-a).forEach(y=>{h+=`<div class="folder" onclick="toggleF('y${y}')"><span>${y}</span><span>[${t[y].c}]</span></div><div id="y${y}" class="f-content">`;Object.keys(t[y].m).sort((a,b)=>b-a).forEach(m=>{h+=`<div class="folder" onclick="toggleF('m${y}${m}')"><span>${mths[m]}</span><span>[${t[y].m[m].c}]</span></div><div id="m${y}${m}" class="f-content">`;Object.keys(t[y].m[m].d).sort((a,b)=>b-a).forEach(dy=>{h+=`<div class="folder" onclick="toggleF('d${y}${m}${dy}')"><span>${dy}</span><span>[${t[y].m[m].d[dy].length}]</span></div><div id="d${y}${m}${dy}" class="f-content">`;t[y].m[m].d[dy].sort((a,b)=>b.ts.localeCompare(a.ts)).forEach(v=>h+=`<div class="card" onclick="openModal('vInv','${v.id}|${dbK}')">${(v.num||'–ë/–ù')}-${v.client||v.supplier}</div>`);h+=`</div>`;});h+=`</div>`;});h+=`</div>`;});c.innerHTML=h||'–ü—É—Å—Ç–æ';}
function rInvC(c){const dbK=(archSub==='In'?'ArchIncoming':'ArchInvoices'),d=data[dbK]||{},cl={};Object.entries(d).forEach(([id,v])=>{const n=v.client||v.supplier;if(!cl[n])cl[n]=[];cl[n].push({...v,id});});let h='';Object.keys(cl).sort().forEach((n,i)=>{h+=`<div class="folder" onclick="toggleF('cl${i}')"><span>${n}</span><span>[${cl[n].length}]</span></div><div id="cl${i}" class="f-content">`;cl[n].sort((a,b)=>b.ts.localeCompare(a.ts)).forEach(v=>h+=`<div class="card" onclick="openModal('vInv','${v.id}|${dbK}')">${(v.num||'–ë/–ù')}-${fd(v.date)}</div>`);h+=`</div>`;});c.innerHTML=h||'–ü—É—Å—Ç–æ';}
function rGen(c){const d=data[cur]||{},t={},u=(cur==='–ü–ª–µ–Ω–∫–∞'?'–∫–≥':(cur==='–°–∫–æ—Ç—á 360 –≥—Ä–∞–º–º'?'—Ä—É–ª':'—à—Ç'));Object.values(d).forEach(v=>{if(v.name)t[v.name]=(t[v.name]||0)+v.amount});let h=`<div class="item-grid ${corrMode?'show-corr':''}">`;Object.keys(t).sort().forEach(k=>{const val=t[k];h+=`<div class="item-card ${val<0?'alarm-blink':''}"><div class="item-title">${k}</div><div class="item-qty">${Math.round(val)} <small>${u}</small></div><div style="display:flex;justify-content:center;gap:4px"><button style="border:none;background:#f0f0f0;font-size:10px;padding:4px;width:45%" onclick="showH('${cur}','k')">üìú</button><button class="corr-btn" onclick="openModal('corr','${cur}|${k}')">¬±</button></div></div>`;});c.innerHTML=h+'</div>';}
auth.onAuthStateChanged(u=>{document.getElementById('uS').innerText=u?u.email.toUpperCase():"–í–•–û–î...";renderHome()});window.onload=renderHome;
</script></body></html>
